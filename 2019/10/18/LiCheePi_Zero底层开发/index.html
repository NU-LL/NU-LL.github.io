<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <title>LiCheePi_Zero底层开发 | 无名小卒</title>
  <meta name="keywords" content=" LiCheePi Zero ">
  <meta name="description" content="LiCheePi_Zero底层开发 | 无名小卒">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="description" content="关于">
<meta property="og:type" content="website">
<meta property="og:title" content="about">
<meta property="og:url" content="http://NU-LL.github.io/about/index.html">
<meta property="og:site_name" content="无名小卒">
<meta property="og:description" content="关于">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2019-07-21T14:30:10.192Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="about">
<meta name="twitter:description" content="关于">


<link rel="icon" href="/img/avatar.jpg">

<link href="/css/style.css?v=1" rel="stylesheet">

<link href="/css/hl_theme/github.css?v=1" rel="stylesheet">

<link href="//cdn.bootcss.com/animate.css/3.5.2/animate.min.css" rel="stylesheet">
<link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

<script src="//cdn.bootcss.com/jquery/2.2.4/jquery.min.js"></script>
<script src="/js/jquery.autocomplete.min.js?v=1"></script>

<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>

<script src="//cdn.bootcss.com/nprogress/0.2.0/nprogress.min.js"></script>



<script src="//cdn.bootcss.com/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

<script src="/js/iconfont.js?v=1"></script>

</head>
<div style="display: none">
  <input class="theme_disqus_on" value="false">
  <input class="theme_preload_comment" value="false">
  <input class="theme_blog_path" value>
</div>

<body>
<aside class="nav">
    <div class="nav-left">
        <a href="/" class="avatar_target">
    <img class="avatar" src="/img/avatar.jpg" />
</a>
<div class="author">
    <span>NU-LL</span>
</div>

<div class="icon">
    
        
    
        
        <a title="github" href="https://github.com/NU-LL" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-github"></use>
                </svg>
            
        </a>
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
    
        
        <a title="csdn" href="https://blog.csdn.net/CSDN_JZ_" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-csdn"></use>
                </svg>
            
        </a>
        
    
        
    
        
    
        
        <a title="email" href="mailto:1125934312@qq.com" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-email"></use>
                </svg>
            
        </a>
        
    
        
        <a title="qq" href="http://wpa.qq.com/msgrd?v=3&uin=1125934312&site=qq&menu=yes" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-qq"></use>
                </svg>
            
        </a>
        
    
        
    
        
        <a title="neteasemusic" href="https://music.163.com/#/user/home?id=323374922" target="_blank">
            
                <svg class="iconfont-svg" aria-hidden="true">
                    <use xlink:href="#icon-neteasemusic"></use>
                </svg>
            
        </a>
        
    
</div>




<ul>
    <li><div class="all active">全部文章<small>(28)</small></div></li>
    
        
            
            <li><div data-rel="Linux">Linux<small>(18)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="Go语言">Go语言<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="工具">工具<small>(4)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="感悟与总结">感悟与总结<small>(2)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="算法">算法<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="STM32">STM32<small>(1)</small></div>
                
            </li>
            
        
    
        
            
            <li><div data-rel="人工智能">人工智能<small>(1)</small></div>
                
            </li>
            
        
    
</ul>
<div class="left-bottom">
    <div class="menus">
    
    
    
    
    </div>
    <div><a style="border-right: 1px solid #fff; width: 49%"  class="about site_url"  href="/about">关于</a><a style="width: 50%"  class="friends">友链</a></div>
</div>
<input type="hidden" id="yelog_site_posts_number" value="28">
<input type="hidden" id="yelog_site_word_count" value="101.7k">
<div style="display: none">
    <span id="busuanzi_value_site_uv"></span>
    <span id="busuanzi_value_site_pv"></span>
</div>

    </div>
    <div class="nav-right">
        <div class="friends-area">
    <div class="friends-title">
        友情链接
        <i class="back-title-list"></i>
    </div>
    <div class="friends-content">
        <ul>
            
            <li><a target="_blank" href="https://github.com/NU-LL">NU-LL</a></li>
            
        </ul>
    </div>
</div>
        <div class="title-list">
    <form onkeydown="if(event.keyCode==13){return false;}">
        <input class="search" type="text" placeholder="Search..." autocomplete="off"id="local-search-input" >
        <i class="cross"></i>
        <span>
            <label for="tagswitch">Tags:</label>
            <input id="tagswitch" type="checkbox" style="display: none" />
            <i id="tagsWitchIcon"></i>
        </span>
    </form>
    <div class="tags-list">
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">DM9000C</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">网卡移植</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color4">Go语言入门经典</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">Kconfig语法</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color1">IIC驱动</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color1">Latex</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">Ctex</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">Linux内核</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color4">LiCheePi Zero</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color1">文件描述符</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color4">Xmanager</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">远程链接</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">字符驱动</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">等待队列</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">wait_queue_head_t</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">wait_queue_t</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color4">Markdown</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color4">git</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color1">NanoPi Neo Core</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color2">u-boot</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color4">存储器</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">markdownlint</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">二维数组</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color3">指针</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">按键驱动</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color2">poll机制</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">快速排序</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color1">根文件系统</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color2">异步通知机制</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color4">IAP</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color1">BootLoader</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">dual bank</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">深度学习</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color2">TensorFlow2</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color4">设备树</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color2">网卡驱动框架</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color5">虚拟网卡</a>
    </li>
    
    <li class="article-tag-list-item">
        <a href="javascript:" class="color1">输入子系统</a>
    </li>
    
    <div class="clearfix"></div>
</div>

    
    <nav id="title-list-nav">
        
        <a  class="Linux "
           href="/2019/08/04/DM9000C网卡移植/"
           data-tag="DM9000C,网卡移植"
           data-author="" >
            <span class="post-title" title="DM9000C网卡移植">DM9000C网卡移植</span>
            <span class="post-date" title="2019-08-04 23:07:22">2019/08/04</span>
        </a>
        
        <a  class="Go语言 "
           href="/2019/10/23/Go语言/"
           data-tag="Go语言入门经典"
           data-author="" >
            <span class="post-title" title="Go语言">Go语言</span>
            <span class="post-date" title="2019-10-23 21:07:25">2019/10/23</span>
        </a>
        
        <a  class="Linux "
           href="/2019/08/15/Kconfig文件语法分析/"
           data-tag="Kconfig语法"
           data-author="" >
            <span class="post-title" title="Kconfig文件语法分析">Kconfig文件语法分析</span>
            <span class="post-date" title="2019-08-15 19:38:40">2019/08/15</span>
        </a>
        
        <a  class="Linux "
           href="/2019/08/05/IIC驱动/"
           data-tag="IIC驱动"
           data-author="" >
            <span class="post-title" title="IIC驱动">IIC驱动</span>
            <span class="post-date" title="2019-08-05 14:39:10">2019/08/05</span>
        </a>
        
        <a  class="工具 "
           href="/2019/08/19/Latex排版全解/"
           data-tag="Latex,Ctex"
           data-author="" >
            <span class="post-title" title="Latex排版全解">Latex排版全解</span>
            <span class="post-date" title="2019-08-19 16:02:27">2019/08/19</span>
        </a>
        
        <a  class="Linux "
           href="/2019/08/13/Linux内核启动流程/"
           data-tag="Linux内核"
           data-author="" >
            <span class="post-title" title="Linux内核启动流程">Linux内核启动流程</span>
            <span class="post-date" title="2019-08-13 16:13:46">2019/08/13</span>
        </a>
        
        <a  class="Linux "
           href="/2019/10/18/LiCheePi_Zero底层开发/"
           data-tag="LiCheePi Zero"
           data-author="" >
            <span class="post-title" title="LiCheePi_Zero底层开发">LiCheePi_Zero底层开发</span>
            <span class="post-date" title="2019-10-18 12:25:42">2019/10/18</span>
        </a>
        
        <a  class="Linux "
           href="/2019/07/21/Linux编程--文件描述符fd/"
           data-tag="文件描述符"
           data-author="" >
            <span class="post-title" title="Linux编程--文件描述符fd">Linux编程--文件描述符fd</span>
            <span class="post-date" title="2019-07-21 10:13:47">2019/07/21</span>
        </a>
        
        <a  class="Linux "
           href="/2019/11/08/Xmanager远程Ubuntu系统图像化界面/"
           data-tag="Xmanager,远程链接"
           data-author="" >
            <span class="post-title" title="Xmanager远程Ubuntu系统图像化界面">Xmanager远程Ubuntu系统图像化界面</span>
            <span class="post-date" title="2019-11-08 22:58:53">2019/11/08</span>
        </a>
        
        <a  class="Linux "
           href="/2019/08/07/RTC驱动分析/"
           data-tag="字符驱动"
           data-author="" >
            <span class="post-title" title="RTC驱动分析">RTC驱动分析</span>
            <span class="post-date" title="2019-08-07 13:37:33">2019/08/07</span>
        </a>
        
        <a  class="Linux "
           href="/2019/07/21/linux等待队列wait_queue_head_t和wait_queue_t/"
           data-tag="等待队列,wait_queue_head_t,wait_queue_t"
           data-author="" >
            <span class="post-title" title="linux等待队列wait_queue_head_t和wait_queue_t">linux等待队列wait_queue_head_t和wait_queue_t</span>
            <span class="post-date" title="2019-07-21 18:18:54">2019/07/21</span>
        </a>
        
        <a  class="工具 "
           href="/2019/07/12/Markdown 语法整理/"
           data-tag="Markdown"
           data-author="" >
            <span class="post-title" title="Markdown 语法整理">Markdown 语法整理</span>
            <span class="post-date" title="2019-07-12 13:57:24">2019/07/12</span>
        </a>
        
        <a  class="工具 "
           href="/2019/09/17/git/"
           data-tag="git"
           data-author="" >
            <span class="post-title" title="git">git</span>
            <span class="post-date" title="2019-09-17 09:59:56">2019/09/17</span>
        </a>
        
        <a  class="Linux "
           href="/2019/10/18/NanoPi_Neo_Core底层开发/"
           data-tag="NanoPi Neo Core"
           data-author="" >
            <span class="post-title" title="NanoPi_Neo_Core底层开发">NanoPi_Neo_Core底层开发</span>
            <span class="post-date" title="2019-10-18 12:25:42">2019/10/18</span>
        </a>
        
        <a  class="Linux "
           href="/2019/08/12/u-boot分析与使用/"
           data-tag="u-boot"
           data-author="" >
            <span class="post-title" title="u-boot分析与使用">u-boot分析与使用</span>
            <span class="post-date" title="2019-08-12 19:16:50">2019/08/12</span>
        </a>
        
        <a  class="感悟与总结 "
           href="/2019/08/11/各种存储器的区别/"
           data-tag="存储器"
           data-author="" >
            <span class="post-title" title="各种存储器的区别">各种存储器的区别</span>
            <span class="post-date" title="2019-08-11 10:57:19">2019/08/11</span>
        </a>
        
        <a  class="工具 "
           href="/2019/09/17/markdownlint规则详细介绍/"
           data-tag="markdownlint"
           data-author="" >
            <span class="post-title" title="VSC插件之markdownlint规则详细介绍">VSC插件之markdownlint规则详细介绍</span>
            <span class="post-date" title="2019-09-17 15:00:13">2019/09/17</span>
        </a>
        
        <a  class="感悟与总结 "
           href="/2019/08/06/二维数组与指针的一些问题/"
           data-tag="二维数组,指针"
           data-author="" >
            <span class="post-title" title="二维数组与指针的一些问题">二维数组与指针的一些问题</span>
            <span class="post-date" title="2019-08-06 13:11:26">2019/08/06</span>
        </a>
        
        <a  class="Linux "
           href="/2019/08/07/字符驱动设备的另一种写法/"
           data-tag="字符驱动"
           data-author="" >
            <span class="post-title" title="字符驱动设备的另一种写法">字符驱动设备的另一种写法</span>
            <span class="post-date" title="2019-08-07 12:20:30">2019/08/07</span>
        </a>
        
        <a  class="Linux "
           href="/2019/07/21/按键驱动——poll机制/"
           data-tag="按键驱动,poll机制"
           data-author="" >
            <span class="post-title" title="按键驱动——poll机制">按键驱动——poll机制</span>
            <span class="post-date" title="2019-07-21 20:30:38">2019/07/21</span>
        </a>
        
        <a  class="算法 "
           href="/2019/07/29/快速排序/"
           data-tag="快速排序"
           data-author="" >
            <span class="post-title" title="快速排序">快速排序</span>
            <span class="post-date" title="2019-07-29 22:27:34">2019/07/29</span>
        </a>
        
        <a  class="Linux "
           href="/2019/08/14/构造根文件系统/"
           data-tag="根文件系统"
           data-author="" >
            <span class="post-title" title="构造根文件系统">构造根文件系统</span>
            <span class="post-date" title="2019-08-14 20:18:45">2019/08/14</span>
        </a>
        
        <a  class="Linux "
           href="/2019/07/22/按键驱动：异步通知机制/"
           data-tag="按键驱动,异步通知机制"
           data-author="" >
            <span class="post-title" title="按键驱动：异步通知机制">按键驱动：异步通知机制</span>
            <span class="post-date" title="2019-07-22 19:04:24">2019/07/22</span>
        </a>
        
        <a  class="STM32 "
           href="/2019/11/12/基于STM32L476的IAP升级/"
           data-tag="IAP,BootLoader,dual bank"
           data-author="" >
            <span class="post-title" title="基于STM32L476的IAP升级">基于STM32L476的IAP升级</span>
            <span class="post-date" title="2019-11-12 22:47:40">2019/11/12</span>
        </a>
        
        <a  class="人工智能 "
           href="/2020/01/03/深度学习与TensorFlow2/"
           data-tag="深度学习,TensorFlow2"
           data-author="" >
            <span class="post-title" title="深度学习与TensorFlow2">深度学习与TensorFlow2</span>
            <span class="post-date" title="2020-01-03 21:04:26">2020/01/03</span>
        </a>
        
        <a  class="Linux "
           href="/2019/10/13/设备树/"
           data-tag="设备树"
           data-author="" >
            <span class="post-title" title="设备树">设备树</span>
            <span class="post-date" title="2019-10-13 15:53:24">2019/10/13</span>
        </a>
        
        <a  class="Linux "
           href="/2019/08/04/网卡驱动程序/"
           data-tag="网卡驱动框架,虚拟网卡"
           data-author="" >
            <span class="post-title" title="网卡驱动程序">网卡驱动程序</span>
            <span class="post-date" title="2019-08-04 21:24:07">2019/08/04</span>
        </a>
        
        <a  class="Linux "
           href="/2019/07/25/输入子系统/"
           data-tag="按键驱动,输入子系统"
           data-author="" >
            <span class="post-title" title="输入子系统">输入子系统</span>
            <span class="post-date" title="2019-07-25 00:05:15">2019/07/25</span>
        </a>
        
    </nav>
</div>
    </div>
    <div class="hide-list">
        <div class="semicircle">
            <div class="brackets first"><</div>
            <div class="brackets">&gt;</div>
        </div>
    </div>
</aside>
<div class="post">
    <div class="pjax">
        <article id="post-LiCheePi_Zero底层开发" class="article article-type-post" itemscope itemprop="blogPost">
    
        <h1 class="article-title">LiCheePi_Zero底层开发</h1>
    
    <div class="article-meta">
        
        
        
        <span class="book">
            
                <a href="javascript:" data-rel="Linux">Linux</a>
            
        </span>
        
        
        <span class="tag">
            
            <a href="javascript:" class="color4">LiCheePi Zero</a>
            
        </span>
        
    </div>
    <div class="article-meta">
        
        创建时间:<time class="date" title='更新时间: 2019-11-24 00:45:11'>2019-10-18 12:25</time>
        
    </div>
    <div class="article-meta">
        
        <span>字数:11.6k</span>
        
        
        <span id="busuanzi_container_page_pv">
            阅读:<span id="busuanzi_value_page_pv">
                <span class="count-comment">
                    <span class="spinner">
                      <div class="cube1"></div>
                      <div class="cube2"></div>
                    </span>
                </span>
            </span>
        </span>
        
        
    </div>
    
    <div class="toc-ref">
    
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#LiCheePi-Zero底层开发"><span class="toc-text">LiCheePi Zero底层开发</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#各种文件"><span class="toc-text">各种文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、编译下载镜像"><span class="toc-text">一、编译下载镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-编译及相关配置"><span class="toc-text">1. 编译及相关配置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1编译uboot"><span class="toc-text">1.1编译uboot</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#修改代码支持SD卡"><span class="toc-text">修改代码支持SD卡</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#修改代码支持SPI-FLASH"><span class="toc-text">修改代码支持SPI FLASH</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2编译Linux内核"><span class="toc-text">1.2编译Linux内核</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1-主线内核"><span class="toc-text">1.2.1 主线内核</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#使用SPI的uboot时需要配置"><span class="toc-text">使用SPI的uboot时需要配置</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#wifi使能配置"><span class="toc-text">wifi使能配置</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2-BSP内核"><span class="toc-text">1.2.2 BSP内核</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-3-单独编译设备树"><span class="toc-text">1.2.3 单独编译设备树</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-4-反编译设备树"><span class="toc-text">1.2.4 反编译设备树</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3buildroot编译根文件系统"><span class="toc-text">1.3buildroot编译根文件系统</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#配置"><span class="toc-text">配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#编译"><span class="toc-text">编译</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#修改控制台颜色"><span class="toc-text">修改控制台颜色</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#构建完后，想要取消登录密码"><span class="toc-text">构建完后，想要取消登录密码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#flash启动"><span class="toc-text">flash启动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#添加wifi工具库（这里有好几个库，推荐用buildroot-）"><span class="toc-text">添加wifi工具库（这里有好几个库，推荐用buildroot ）</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#单独编译wireless-tools工具集"><span class="toc-text">单独编译wireless tools工具集</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#编译。。。。工具集（以后再写）"><span class="toc-text">编译。。。。工具集（以后再写）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#buildroot-编译"><span class="toc-text">buildroot 编译</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-下载"><span class="toc-text">2. 下载</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-SD卡"><span class="toc-text">2.1 SD卡</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-1-修改uboot源码设置启动命令"><span class="toc-text">2.1.1 修改uboot源码设置启动命令</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-2-利用boot-scr和script-bin"><span class="toc-text">2.1.2 利用boot.scr和script.bin</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#boot-src是什么"><span class="toc-text">boot.src是什么</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#boot-src如何生成"><span class="toc-text">boot.src如何生成</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#script-bin是什么"><span class="toc-text">script.bin是什么</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#script-bin如何生成"><span class="toc-text">script.bin如何生成</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-1-3-分区及下载"><span class="toc-text">2.1.3 分区及下载</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-SPI-FLASH"><span class="toc-text">2.2 SPI FLASH</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#分区情况"><span class="toc-text">分区情况</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#生成img镜像"><span class="toc-text">生成img镜像</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#烧写镜像"><span class="toc-text">烧写镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#安装sunxiflash烧写工具"><span class="toc-text">安装sunxiflash烧写工具</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#进入下载（fel）模式"><span class="toc-text">进入下载（fel）模式</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#下载"><span class="toc-text">下载</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#dd命令详解"><span class="toc-text">dd命令详解</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#dev-null和-dev-zero的区别"><span class="toc-text">/dev/null和/dev/zero的区别</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、开发环境搭建"><span class="toc-text">二、开发环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rtl8723bs无线网卡搭建"><span class="toc-text">rtl8723bs无线网卡搭建</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、移植OPENCV（3-4-1）"><span class="toc-text">三、移植OPENCV（3.4.1）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#配置编译OPENCV"><span class="toc-text">配置编译OPENCV</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OPENCV开发"><span class="toc-text">OPENCV开发</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、驱动编写"><span class="toc-text">四、驱动编写</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#写在前面"><span class="toc-text">写在前面</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#内核版本查看方法"><span class="toc-text">内核版本查看方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#挂载pc上文件系统"><span class="toc-text">挂载pc上文件系统</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#一键挂载脚本"><span class="toc-text">一键挂载脚本</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#卸载脚本"><span class="toc-text">卸载脚本</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#更换源"><span class="toc-text">更换源</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-按键驱动程序"><span class="toc-text">1.按键驱动程序</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1修改设备树"><span class="toc-text">1.1修改设备树</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#编译设备树"><span class="toc-text">编译设备树</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#查看系统中是否存在对应节点"><span class="toc-text">查看系统中是否存在对应节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#设备树中的GPIO节点"><span class="toc-text">设备树中的GPIO节点</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2编写驱动"><span class="toc-text">1.2编写驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-1检查注册的驱动"><span class="toc-text">1.2.1检查注册的驱动</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1-2-2gpiolib及gpio操作"><span class="toc-text">1.2.2gpiolib及gpio操作</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#经典接口"><span class="toc-text">经典接口</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#新接口"><span class="toc-text">新接口</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#读写gpio"><span class="toc-text">读写gpio</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#控制台中查看当前gpio占用情况的方法"><span class="toc-text">控制台中查看当前gpio占用情况的方法</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3调试"><span class="toc-text">1.3调试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#printk"><span class="toc-text">printk</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#后台运行"><span class="toc-text">后台运行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-内核定时器"><span class="toc-text">2.内核定时器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-中断"><span class="toc-text">3.中断</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#上半部和下半部"><span class="toc-text">上半部和下半部</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1修改设备树"><span class="toc-text">3.1修改设备树</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#相关函数"><span class="toc-text">相关函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#编译设备树-1"><span class="toc-text">编译设备树</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#查看系统中是否存在对应节点-1"><span class="toc-text">查看系统中是否存在对应节点</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#设备树中的中断节点"><span class="toc-text">设备树中的中断节点</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-2编写驱动"><span class="toc-text">3.2编写驱动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3调试"><span class="toc-text">3.3调试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-input子系统"><span class="toc-text">4.input子系统</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1修改设备树"><span class="toc-text">4.1修改设备树</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2编写驱动"><span class="toc-text">4.2编写驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#相关函数-1"><span class="toc-text">相关函数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#input-dev的相关事件"><span class="toc-text">input_dev的相关事件</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-3调试"><span class="toc-text">4.3调试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-IIC框架驱动"><span class="toc-text">5.IIC框架驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#5-1设备树"><span class="toc-text">5.1设备树</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-2驱动"><span class="toc-text">5.2驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#基本数据结构"><span class="toc-text">基本数据结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#相关函数-2"><span class="toc-text">相关函数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-3调试"><span class="toc-text">5.3调试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#i2c-tools工具"><span class="toc-text">i2c-tools工具</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-SPI框架驱动"><span class="toc-text">6.SPI框架驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#6-1设备树"><span class="toc-text">6.1设备树</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-2驱动"><span class="toc-text">6.2驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#基本数据结构-1"><span class="toc-text">基本数据结构</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#相关函数-3"><span class="toc-text">相关函数</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-3调试"><span class="toc-text">6.3调试</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-RGBLCD驱动"><span class="toc-text">7.RGBLCD驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#7-1设备树"><span class="toc-text">7.1设备树</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#1-添加framebuffer"><span class="toc-text">1.添加framebuffer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#2-添加屏幕节点"><span class="toc-text">2.添加屏幕节点</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7-3调试"><span class="toc-text">7.3调试</span></a></li></ol></li></ol></li></ol></li></ol>
    
<style>
    .left-col .switch-btn,
    .left-col .switch-area {
        display: none;
    }
    .toc-level-6 i,
    .toc-level-6 ol {
        display: none !important;
    }
</style>
</div>
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="LiCheePi-Zero底层开发"><a href="#LiCheePi-Zero底层开发" class="headerlink" title="LiCheePi Zero底层开发"></a>LiCheePi Zero底层开发</h1><p> <img src="//NU-LL.github.io/2019/10/18/LiCheePi_Zero底层开发/fb63cd12ae1def9dd50710d2a32dc5c1_1095x740.png" alt="GPIO引脚图"> </p>
<h2 id="各种文件"><a href="#各种文件" class="headerlink" title="各种文件"></a>各种文件</h2><p>烧录工具：sunxi-tools-spi-rebase.zip</p>
<p>根文件系统：buildroot-2019.08.tar.bz2</p>
<p>交叉编译器：gcc-linaro-6.3.1-2017.02-x86_64_arm-linux-gnueabihf.tar.xz</p>
<p>Uboot：u-boot-3s-current.zip</p>
<ul>
<li>spi nor flash启动：u-boot-3s-spi-experimental.zip</li>
</ul>
<p>主线Linux内核：linux-zero-4.10.y.zip、linux-zero-4.13.y.zip </p>
<p>BSP内核：v3s_lichee.zip（ camdriod ，需要从中剥离出内核）</p>
<h2 id="一、编译下载镜像"><a href="#一、编译下载镜像" class="headerlink" title="一、编译下载镜像"></a>一、编译下载镜像</h2><h3 id="1-编译及相关配置"><a href="#1-编译及相关配置" class="headerlink" title="1. 编译及相关配置"></a>1. 编译及相关配置</h3><h4 id="1-1编译uboot"><a href="#1-1编译uboot" class="headerlink" title="1.1编译uboot"></a>1.1编译uboot</h4><pre><code class="bash">#480x272LCD：LicheePi_Zero_480x272LCD_defconfig
#800x480LCD：LicheePi_Zero_800x480LCD_defconfig
#make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- LicheePi_Zero_480x272LCD_defconfig
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- LicheePi_Zero_defconfig
make ARCH=arm menuconfig#配置
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j8</code></pre>
<p> 编译完成后，在当前目录下生成了<code>u-boot-sunxi-with-spl.bin</code> </p>
<blockquote>
<p>自定义uboot配置</p>
<p>该部分属于自定义部分，可以直接采用默认配置</p>
<ul>
<li>Architecture select架构选择：ARM架构 </li>
<li>ARM architecture<ul>
<li>DDR相关配置</li>
<li>LCD相关配置</li>
</ul>
</li>
<li>Boot images<ul>
<li>CPU clock frequency：时钟频率配置</li>
</ul>
</li>
<li>delay in seconds before automatically booting：开机等待时间的秒数</li>
<li>SPL/TPL<ul>
<li>MMC raw mode: by sector                       按扇区</li>
<li>Address on the MMC to load U-Boot from  mmc加载uboot的地址</li>
<li>Support GPIO                                 支持GPIO</li>
<li>Support I2C                                 支持I2C</li>
<li>Support common libraries                    支持通用lib</li>
<li>Support disk paritions                      支持分区</li>
<li>Support generic libraries                   支持一般lib库</li>
<li>Support MMC                                 支持MMC</li>
<li>Support power drivers                  支持电源驱动</li>
<li>Support serial                               支持串口</li>
</ul>
</li>
</ul>
</blockquote>
<h5 id="修改代码支持SD卡"><a href="#修改代码支持SD卡" class="headerlink" title="修改代码支持SD卡"></a>修改代码支持SD卡</h5><p>源码：u-boot-3s-current</p>
<p>增加uboot源码中<code>include/configs/sun8i.h</code> ：</p>
<pre><code class="c">#define CONFIG_BOOTCOMMAND      &quot;load mmc 0:1 0x41000000 zImage;&quot;  \
                            &quot;load mmc 0:1 0x41800000 sun8i-v3s-licheepi-zero.dtb;&quot; \
                            &quot;bootz 0x41000000 - 0x41800000;&quot;

#define CONFIG_BOOTARGS      &quot;console=ttyS0,115200 panic=5 rootwait root=/dev/mmcblk0p2 earlyprintk rw vt.global_cursor_default=0&quot;</code></pre>
<h5 id="修改代码支持SPI-FLASH"><a href="#修改代码支持SPI-FLASH" class="headerlink" title="修改代码支持SPI FLASH"></a>修改代码支持SPI FLASH</h5><p>源码：u-boot-3s-spi-experimental</p>
<p>如果flash大于16M，需要修改uboot配置，勾选flash bank支持选项（ CONFIG_SPI_FLASH_BAR ）</p>
<p>增加uboot源码中<code>include/configs/sun8i.h</code> ：</p>
<pre><code class="c">#define CONFIG_BOOTCOMMAND   &quot;sf probe 0; &quot;                           \
                             &quot;sf read 0x41800000 0x100000 0x10000; &quot;  \/*从flash0x100000（1MB）位置读取dtb放到内存0x41800000偏移处。 //如果是bsp的bin，则是0x41d00000*/
                             &quot;sf read 0x41000000 0x110000 0x400000; &quot; \
                             &quot;bootz 0x41000000 - 0x41800000&quot;

#define CONFIG_BOOTARGS      &quot;console=ttyS0,115200 earlyprintk panic=5 rootwait &quot; \
                             &quot;mtdparts=spi32766.0:1M(uboot)ro,64k(dtb)ro,4M(kernel)ro,-(rootfs) root=31:03 rw rootfstype=jffs2&quot;</code></pre>
<h4 id="1-2编译Linux内核"><a href="#1-2编译Linux内核" class="headerlink" title="1.2编译Linux内核"></a>1.2编译Linux内核</h4><h5 id="1-2-1-主线内核"><a href="#1-2-1-主线内核" class="headerlink" title="1.2.1 主线内核"></a>1.2.1 主线内核</h5><pre><code class="bash">#bsp内核中用到是arm-linux-gnueabi-，工具链为自带的4.6.3
make ARCH=arm licheepi_zero_defconfig
make ARCH=arm menuconfig   #add bluethooth, etc.
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j16
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j16 modules
#INSTALL_MOD_PATH：把指定为M的驱动安装到指定文件系统根目录下面的/lib/modules目录下面
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j16 INSTALL_MOD_PATH=指定文件系统根目录 modules_install</code></pre>
<p>编译完成后，zImage在<code>arch/arm/boot/</code>下，驱动模块在INSTALL_MOD_PATH指定的目录下 </p>
<h6 id="使用SPI的uboot时需要配置"><a href="#使用SPI的uboot时需要配置" class="headerlink" title="使用SPI的uboot时需要配置"></a>使用SPI的uboot时需要配置</h6><pre><code>Device Drivers
    &lt;*&gt; Memory Technology Device (MTD) support  ---&gt;
        &lt;*&gt;   Command line partition table parsing//解析uboot传递过来的flash分区信息。
        &lt;*&gt;   SPI-NOR device support  ---&gt;//支持SPI-NOR 设备
File systems
    [*] Miscellaneous filesystems  ---&gt;
        &lt;*&gt;   Journalling Flash File System v2 (JFFS2) support//添加对jffs2文件系统的支持</code></pre><p>设备树中添加spi flash节点信息</p>
<pre><code>&amp;spi0 {
        status =&quot;okay&quot;;
        xt25f128b:xt25f128b@0 {
                compatible = &quot;jedec,spi-nor&quot;;
                reg = &lt;0x0&gt;;
                spi-max-frequency = &lt;50000000&gt;;
                #address-cells = &lt;1&gt;;
                #size-cells = &lt;1&gt;;
        };
};</code></pre><p>内核代码<code>drivers/mtd/devices/m25p80.c</code>中添加flash型号</p>
<pre><code class="c">static const struct spi_device_id m25p_ids[] = {
    ...
    {&quot;w25q80bl&quot;},    {&quot;w25q128&quot;},/* add xt25f128b --by jz */{&quot;xt25f128b&quot;},/* add xt25f128b --by jz */    {&quot;w25q256&quot;},
    ...
    { },
};</code></pre>
<p>内核代码<code>drivers/mtd/spi-nor/spi-nor.c</code>中添加flash型号</p>
<pre><code class="c">static const struct flash_info spi_nor_ids[] = {
    ...
    { &quot;w25q128&quot;, INFO(0xef4018, 0, 64 * 1024, 256, SECT_4K) },
    {&quot;xt25f128b&quot;,INFO(0x0b4018, 0, 64 * 1024, 256, 0) },/*add xt25f128b   by j.z.*/
    { &quot;w25q256&quot;, INFO(0xef4019, 0, 64 * 1024, 512, SECT_4K) },
    ...
    { },
};</code></pre>
<ul>
<li>mkfs.jffs2 使用的最小擦除尺寸是8KB，而spi flash的扇区大小是4KB，所以按照扇区擦除的话，会无法使用，所以必须使用块擦除。 所以这里应该去掉SECT_4K</li>
</ul>
<h6 id="wifi使能配置"><a href="#wifi使能配置" class="headerlink" title="wifi使能配置"></a>wifi使能配置</h6><p>linux-zero-4.10.y.zip 内核才有<code>rtl8723bs</code>wifi的驱动（默认支持，编译成模块）</p>
<pre><code>-&gt; Device Drivers
    -&gt; Staging drivers (STAGING [=y])
        &lt;M&gt;   Realtek RTL8723BS SDIO Wireless LAN NIC driver (CONFIG_RTL8723BS)


//尝试去支持ov2640 但是貌似不起效 先记着
-&gt; Device Drivers
    -&gt; Multimedia support (MEDIA_SUPPORT [=y])
        [*]   Cameras/video grabbers support
        [*]   V4L platform devices  ---&gt;
        [ ]   Autoselect ancillary drivers (tuners, sensors, i2c, spi, frontends)
        -&gt; I2C Encoders, decoders, sensors and other helper chips
            &lt;M&gt; OmniVision OV2640 sensor support (CONFIG_VIDEO_OV2640)
            &lt;M&gt; OmniVision OV2659 sensor support
            &lt;M&gt; OmniVision OV7640 sensor support
            &lt;M&gt; OmniVision OV7670 sensor support
//尝试去支持lcd
-&gt; Device Drivers
    Graphics support  ---&gt;
        [*] Backlight &amp; LCD device support  ---&gt;//LCD和背光控制
            Console display driver support  ---&gt;//控制台Framebuffer支持
                [*]   Framebuffer Console Rotation
        [*] Bootup logo  ---&gt;//linux启动的开机界面</code></pre><p>使能之后还需要<code>rtl8723bs_nic.bin</code>wifi固件，放到 <code>/lib/firmware/rtlwifi/</code> 中，没有的话要自己建立。</p>
<h5 id="1-2-2-BSP内核"><a href="#1-2-2-BSP内核" class="headerlink" title="1.2.2 BSP内核"></a>1.2.2 BSP内核</h5><ul>
<li><p>解压v3s_lichee.zip， BSP内核源码在lichee/linux-3.4下</p>
<ul>
<li><p>采用WhyCan上大佬的配置文件lichee_BSP_config ：<code>cp lichee_BSP_config .config</code> </p>
</li>
<li><p>配置内核 <code>make ARCH=arm menuconfig</code> （下面这些均基于默认配置）</p>
<ul>
<li><p>使能USB摄像头驱动（已经使能）：</p>
<pre><code>  -&gt; Device Drivers
      -&gt; Multimedia support (MEDIA_SUPPORT [=y])
          -&gt; Video capture adapters (VIDEO_CAPTURE_DRIVERS [=y])
              -&gt; V4L USB devices (V4L_USB_DRIVERS [=y])
                  -&gt;&lt;M&gt;   USB Video Class (UVC)  CONFIG_USB_VIDEO_CLASS</code></pre></li>
<li><p>使能DVP/MIPI摄像头（需选上ov2640）：</p>
<pre><code>  -&gt; Device Drivers
      -&gt; Multimedia support (MEDIA_SUPPORT [=y])
          -&gt; Video capture adapters (VIDEO_CAPTURE_DRIVERS [=y])
              -&gt; V4L platform devices (V4L_PLATFORM_DRIVERS [=y])
                  -&gt; SoC camera support (SOC_CAMERA [=y])
                      &lt;M&gt;     ov2640 camera support（默认没有选上）
                      &lt;M&gt;     ov5642 camera support
                      &lt;M&gt;   sunxi video front end (camera and etc)driver
                      &lt;M&gt;     v4l2 driver for SUNXI
          &lt;*&gt;   sunxi video encoder and decoder support</code></pre></li>
<li><p>由于camdriod原始的内核配置是为了在spi nor flash上运行而配置的，没有ext4支持，所以需要额外添加ext4支持（已经使能）：</p>
<pre><code> File systems  ---&gt;
     &lt;*&gt; The Extended 4 (ext4) filesystem
     [*]   Use ext4 for ext2/ext3 file systems (NEW)
     [*]   Ext4 extended attributes (NEW)
     [ ]     Ext4 POSIX Access Control Lists (NEW)
     [ ]     Ext4 Security Labels (NEW)
     [ ]   EXT4 debugging support (NEW)
     [ ] JBD2 (ext4) debugging support (NEW)
 #支持大文件，以便于挂载文件系统
 [*] Enable the block layer  ---&gt;
     [*]   Support for large (2TB+) block devices and files
 #加上CGROUPS支持
 -&gt; General setup
      [*] Control Group support  ---&gt;
 #开启SWAP
 -&gt; General setup
      [*] Support for paging of anonymous memory (swap)</code></pre></li>
<li><p>开启 FHANDLE 特性（ 否则debian下会出现报错）（已经使能）：</p>
<pre><code>  -&gt; General setup
      [*] open by fhandle syscalls (EXPORTFS [=y])</code></pre></li>
<li><p>开启wifi功能（AW_RF_PM功能未使能）</p>
<pre><code>  #开启RTL8723BS的支持
  -&gt; Device Drivers
      -&gt; Network device support (NETDEVICES [=y])
          -&gt; Wireless LAN (WLAN [=y])
              &lt;M&gt;   Realtek 8723B SDIO WiFi
  #开启AW_RF_PM功能
  -&gt; Device Drivers
      -&gt; Misc devices
          [*] Allwinner rf module pm driver</code></pre></li>
</ul>
</li>
</ul>
</li>
<li><p>编译并提取bsp内核</p>
<ul>
<li><p>解压buildroot/dl/gcc-linaro.tar.bz2到lichee/out/sun8iw8p1/linux/common/buildroot/external-toolchain</p>
<pre><code class="bash">#在lichee目录下
mkdir -p out/sun8iw8p1/linux/common/buildroot/external-toolchain
tar --strip-components=1 -jxf buildroot/dl/gcc-linaro.tar.bz2 -C out/sun8iw8p1/linux/common/buildroot/external-toolchain
touch out/sun8iw8p1/linux/common/buildroot/external-toolchain/.installed

mv out/sun8iw8p1/linux/common/buildroot/external-toolchain/gcc-linaro/* out/sun8iw8p1/linux/common/buildroot/external-toolchain/
rm -rf out/sun8iw8p1/linux/common/buildroot/external-toolchain/gcc-linaro/</code></pre>
</li>
<li><p>安装<code>lib32z1</code>解决64位的操作系统中没有32位的类库的问题</p>
<pre><code class="bash">sudo apt-get update
sudo apt-get install lib32z1</code></pre>
</li>
<li><p>在linux-3.4目录下执行：</p>
<pre><code class="bash">#使用解压的工具链
export PATH=../out/sun8iw8p1/linux/common/buildroot/external-toolchain/bin:../tools/pack/pctools/linux/android:$PATH
#清除上次编译
./scripts/build_tiger-cdr.sh clean
#直接编译
#后面的选项根据lichee\linux-3.4\arch\arm\configs\sun8iw8p1smp_defconfig来配置
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- -j16
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- -j16 modules
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- -j16 INSTALL_MOD_PATH=/home/null/Code/LiCheePi_Zero/Image/cam_image/rootfs modules_install

#LICHEE_JLEVEL：-j${LICHEE_JLEVEL}
#LICHEE_JLEVEL=8 ./scripts/build_tiger-cdr.sh
#./scripts/build_sun8iw8p1.sh all</code></pre>
</li>
</ul>
</li>
</ul>
<h5 id="1-2-3-单独编译设备树"><a href="#1-2-3-单独编译设备树" class="headerlink" title="1.2.3 单独编译设备树"></a>1.2.3 单独编译设备树</h5><pre><code class="bash">make ARCH=arm licheepi_zero_defconfig
make dtbs ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j8
#bsp内核编译设备树：
dtc -I dts -O dtb -o ../sun8i-v3s-blueberrypi-csi-ov2640-480x272LCD.dtb ../sun8i-v3s-blueberrypi-csi-ov2640-480x272LCD.dts
./scripts/dtc/dtc -I dts -O dtb -o ../sun8i-v3s-blueberrypi-csi-ov2640-480x272LCD.dtb ./arch/arm/boot/dts/sun8i-v3s-blueberrypi-csi-ov2640-480x272LCD.dts</code></pre>
<p>如果设备树中有include包含关系，是不能够直接用dtc编译的，会报include相关的错。</p>
<p>DTC本身不支持#include语法，其正确语法为<code>/include/</code>。 </p>
<p>对于以下稍微复杂一点（包含#include，宏，*.h等）的设备树，以上的方法不免有些笨拙。 </p>
<p>由于“#include”“宏”等都是C的特征，因此可以使用CPP(C Preprocessor)命令对dts源文件进行处理，完成文件包含与宏置换的工作。 </p>
<p>用下面的脚本dts2dtb.sh可以实现目的：</p>
<pre><code class="bash">#/bin/bash
#set -vx
device=&quot;your_device_name&quot;
src_dts=$device.dts
tmp_dts=$device.tmp.dts
dst_dtb=$device.dtb

cpp -nostdinc -I. -undef -x assembler-with-cpp $src_dts &gt; $tmp_dts
dtc -O dtb -b 0 -o $dst_dtb $tmp_dts
rm $tmp_dts</code></pre>
<h5 id="1-2-4-反编译设备树"><a href="#1-2-4-反编译设备树" class="headerlink" title="1.2.4 反编译设备树"></a>1.2.4 反编译设备树</h5><pre><code class="bash">./scripts/dtc/dtc -I dtb -O dts -o ../sun8i-v3s-licheepi-zero.dts ./arch/arm/boot/dts/sun8i-v3s-licheepi-zero.dtb
./scripts/dtc/dtc -I dtb -O dts -o ../sun8i-v3s-licheepi-zero-dock.dts ./arch/arm/boot/dts/sun8i-v3s-licheepi-zero-dock.dtb
#bsp内核反汇编：
dtc -I dtb -O dts -o ../sun8i-v3s-blueberrypi-csi-ov2640.dts ../sun8i-v3s-blueberrypi-csi-ov2640.dtb</code></pre>
<h4 id="1-3buildroot编译根文件系统"><a href="#1-3buildroot编译根文件系统" class="headerlink" title="1.3buildroot编译根文件系统"></a>1.3buildroot编译根文件系统</h4><pre><code class="bash">make menuconfig</code></pre>
<h5 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h5><pre><code>target options 
    -&gt; Target Architecture = ARM (little endian)
    -&gt; Target Binary Format = ELF
    -&gt; Target Architecture Variant = cortex-A7
    -&gt; Target ABI = EABIhf
    -&gt; Floating point strategy = VFPv4
    -&gt; ARM instruction set = ARM
Toolchain
    -&gt; Toolchain type = External toolchain
    -&gt; Toolchain = Custom toolchain //用户自己的交叉编译器
    -&gt; Toolchain origin = Pre-installed toolchain //预装的编译器
    -&gt; Toolchain path =/home/null/Toolchain/6.3.1/
    -&gt; Toolchain prefix = $(ARCH)-linux-gnueabihf //前缀
    -&gt; External toolchain gcc version = 6.x
    -&gt; External toolchain kernel headers series = 4.6.x//可在内核文件夹根目录Makefile文件中查看相应内核版本
    -&gt; External toolchain C library = glibc/eglibc
    -&gt; [*] Toolchain has SSP support? (NEW) //选中
    -&gt; [*] Toolchain has RPC support? (NEW) //选中
    -&gt; [*] Toolchain has C++ support? //选中
    -&gt; [*] Enable MMU support (NEW) //选中
System configuration
    -&gt; System hostname = LiCheePiZero //平台名字，自行设置
    -&gt; System banner = Welcome to Buildroot //欢迎语
    -&gt; Init system = BusyBox //使用 busybox
    -&gt; /dev management = Dynamic using devtmpfs + mdev //使用 mdev
    -&gt; [*] Enable root login with password (NEW) //使能登录密码
    -&gt; Root password = 55555 //登录密码为 55555
Filesystem images
    -&gt; [*] ext2/3/4 root filesystem //如果是 EMMC 或 SD 卡的话就用 ext3/ext4
        -&gt; ext2/3/4 variant = ext4 //选择 ext4 格式
    -&gt; [*] ubi image containing an ubifs root filesystem //如果使用 NAND 的话就用 ubifs</code></pre><h5 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h5><pre><code class="bash">sudo make -j8</code></pre>
<p>编译完成后会在 buildroot/output/images 下生成根文件系统</p>
<h5 id="修改控制台颜色"><a href="#修改控制台颜色" class="headerlink" title="修改控制台颜色"></a>修改控制台颜色</h5><p>编辑<code>/etc/profile</code>文件，修改如下语句</p>
<pre><code class="bash">if [ &quot;$PS1&quot; ]; then
        if [ &quot;`id -u`&quot; -eq 0 ]; then
                export PS1=&#39;# &#39;
        else
                export PS1=&#39;$ &#39;
        fi
fi
#改为
if [ &quot;$PS1&quot; ]; then
        if [ &quot;`id -u`&quot; -eq 0 ]; then
                export PS1=&#39;\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\# &#39;
        else
                export PS1=&#39;\[\033[01;32m\]\u@\h\[\033[00m\]:\[\033[01;34m\]\w\[\033[00m\]\$ &#39;
        fi
fi</code></pre>
<p>使能配置</p>
<pre><code class="bash">source /etc/profile</code></pre>
<h5 id="构建完后，想要取消登录密码"><a href="#构建完后，想要取消登录密码" class="headerlink" title="构建完后，想要取消登录密码"></a>构建完后，想要取消登录密码</h5><p>（在buildroot的menuconfig中可以配置取消密码，这里是假设是配置完毕后想要取消）</p>
<ul>
<li>方法一（参考官方手册）</li>
</ul>
<p>修改/etc/inittab:</p>
<pre><code class="bash">ttyS0::respawn:/root/logintest -L ttyS0 115200 vt100</code></pre>
<p>新建logintest：</p>
<pre><code class="bash">#!/bin/sh
/bin/login -f root</code></pre>
<p>自启动任务在/etc/init.d/rcS中加入即可</p>
<p>export 相关环境变量在/etc/profile中加入。 </p>
<ul>
<li>方法二</li>
</ul>
<p>找到 <code>/etc/inittab</code> 文件的</p>
<pre><code class="bash">console::respawn:/sbin/getty -L console 0 vt100 # GENERIC_SERIAL</code></pre>
<p>修改为:</p>
<pre><code class="bash">console::respawn:-/bin/sh</code></pre>
<h5 id="flash启动"><a href="#flash启动" class="headerlink" title="flash启动"></a>flash启动</h5><p>flash启动时需要jffs2格式的文件系统， 所以需要使用此rootfs制作jffs2文件系统镜像</p>
<p>下载jffs2文件系统制作工具</p>
<pre><code class="bash">apt-get install mtd-utils</code></pre>
<p>解压 rootfs.tar</p>
<pre><code class="bash">mkdir rootfs
tar xvf rootfs.tar -C rootfs</code></pre>
<p>安装内核模块</p>
<pre><code class="bash">make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j16 modules
#INSTALL_MOD_PATH：把指定为M的驱动安装到指定文件系统根目录下面的/lib/modules目录下面
make ARCH=arm CROSS_COMPILE=arm-linux-gnueabihf- -j16 INSTALL_MOD_PATH=/home/null/Code/LiCheePi_Zero/Image/spi_image_10_28/rootfs modules_install</code></pre>
<p>计算好jffs的大小，总空间是16M-1M-64K-4M=0xAF0000</p>
<pre><code class="bash">#页大小0x100 256字节
#块大小0x10000 64k
#jffs2分区总空间0xAF0000=16M-1M-64K-4M
#jffs2.img是生成的文件系统镜像
du -h ./rootfs#测试文件夹大小
mkfs.jffs2 -s 0x100 -e 0x10000 -p 0xAF0000 -d rootfs/ -o jffs2.img</code></pre>
<p>删除rootfs文件夹</p>
<pre><code class="bash">rm -rf rootfs/</code></pre>
<p>或者重新打包回rootfs.tar</p>
<pre><code class="bash">tar -cvf rootfs.tar ./rootfs</code></pre>
<h5 id="添加wifi工具库（这里有好几个库，推荐用buildroot-）"><a href="#添加wifi工具库（这里有好几个库，推荐用buildroot-）" class="headerlink" title="添加wifi工具库（这里有好几个库，推荐用buildroot ）"></a>添加wifi工具库（这里有好几个库，推荐用buildroot ）</h5><h6 id="单独编译wireless-tools工具集"><a href="#单独编译wireless-tools工具集" class="headerlink" title="单独编译wireless tools工具集"></a>单独编译wireless tools工具集</h6><p>修改Makefile中的  CC、 AR 和 RANLIB 这三个变量：</p>
<pre><code class="makefile">## Compiler to use (modify this for cross compile).
CC = arm-linux-gnueabihf-gcc
## Other tools you need to modify for cross compile (static lib only).
AR = arm-linux-gnueabihf-ar
RANLIB = arm-linux-gnueabihf-ranlib</code></pre>
<ul>
<li><p>清理：make clean</p>
</li>
<li><p>编译：make</p>
</li>
</ul>
<p>编译完成以后就会在当前目录下生成 iwlist、 iwconfig、 iwspy、 iwpriv、 ifrename 这 5 个工<br>具，另外还有很重要的 libiw.so.29 这个库文件。将这 5 个工具拷贝到开发板根文件系统下的<br>/usr/bin 目录中  ，将 libiw.so.29 这个库文件拷贝到开发板根文件系统下的/usr/lib 目录中</p>
<pre><code class="bash">sudo cp iwlist iwconfig iwspy iwpriv ifrename /home/null/Code/LiCheePi_Zero/Image/spi_image_wifi/rootfs/usr/bin -f
sudo cp libiw.so.29 /home/null/Code/LiCheePi_Zero/Image/spi_image_wifi/rootfs/usr/lib -f</code></pre>
<h6 id="编译。。。。工具集（以后再写）"><a href="#编译。。。。工具集（以后再写）" class="headerlink" title="编译。。。。工具集（以后再写）"></a>编译。。。。工具集（以后再写）</h6><h6 id="buildroot-编译"><a href="#buildroot-编译" class="headerlink" title="buildroot 编译"></a>buildroot 编译</h6><p>配置使能</p>
<pre><code>-&gt; make menuconfig
  -&gt; Target packages
      -&gt; Networking applications
      [*] wireless tools//其目录下全选中
      [*] wpa_supplicant//其目录下全选中</code></pre><h3 id="2-下载"><a href="#2-下载" class="headerlink" title="2. 下载"></a>2. 下载</h3><h4 id="2-1-SD卡"><a href="#2-1-SD卡" class="headerlink" title="2.1 SD卡"></a>2.1 SD卡</h4><h5 id="2-1-1-修改uboot源码设置启动命令"><a href="#2-1-1-修改uboot源码设置启动命令" class="headerlink" title="2.1.1 修改uboot源码设置启动命令"></a>2.1.1 修改uboot源码设置启动命令</h5><p>参考1.1节修改uboot源码后可以直接启动，无需boot.scr和script.bin这两个文件</p>
<h5 id="2-1-2-利用boot-scr和script-bin"><a href="#2-1-2-利用boot-scr和script-bin" class="headerlink" title="2.1.2 利用boot.scr和script.bin"></a>2.1.2 利用boot.scr和script.bin</h5><p>在不修改uboot源码的情况下，可以通过两个启动参数文件：<code>boot.scr</code>和<code>script.bin</code>来配置</p>
<h6 id="boot-src是什么"><a href="#boot-src是什么" class="headerlink" title="boot.src是什么"></a>boot.src是什么</h6><p> 根据资料描述 <a href="https://github.com/linux-sunxi/u-boot-sunxi/wiki#bootscr-support" target="_blank" rel="noopener">https://github.com/linux-sunxi/u-boot-sunxi/wiki#bootscr-support</a>，u-boot在启动的时候会在第一个分区（FAT/extX格式）寻找/boot.scr或者/boot/boot.scr文件，boot.scr中可以包含用于载入script.bin，kernel，initrd（可选）以及设置内核启动参数的uboot命令。  （相当于uboot的bootcmd启动命令）</p>
<h6 id="boot-src如何生成"><a href="#boot-src如何生成" class="headerlink" title="boot.src如何生成"></a>boot.src如何生成</h6><p> 在工作目录新建 <code>boot.cmd</code> 文件，添加以下内容（即uboot启动命令）：</p>
<pre><code class="bash">setenv bootargs console=ttyS0,115200 panic=5 rootwait root=/dev/mmcblk0p2 earlyprintk rw vt.global_cursor_default=0
setenv bootm_boot_mode sec
setenv machid 1029
load mmc 0:1 0x41000000 zImage
#以下两句二选一
#load mmc 0:1 0x41d00000 script.bin#13M偏移
load mmc 0:1 0x41800000 sun8i-v3s-licheepi-zero-dock.dtb#8M偏移
#bootm 0x41000000
bootz 0x41000000 - 0x41800000

#fatload mmc 0 0x43000000 boot/script.bin
#fatload mmc 0 0x48000000 boot/uImage

#也可以不用这么麻烦，用以下命令直接写死在uboot中也行
setenv bootcmd &#39;load mmc 0:1 0x41000000 zImage;load mmc 0:1 0x41800000 sun8i-v3s-blueberrypi-csi-ov2640-480x272LCD.dtb;bootz 0x41000000 - 0x41800000;&#39;
saveenv</code></pre>
<p>详细解释： </p>
<p>1.上述第一行设置uboot的bootargs启动参数，格式为 参数=值，不同参数使用空格分开，其中 </p>
<ul>
<li>console=ttyS0,115200 含义为使用特定的串口ttyS0，波特率为 115200</li>
<li>noinitrd 含义为不使用ramdisk（内存磁盘）</li>
<li>init=/init 含义为内核启起来后，进入系统中运行的第一个脚本</li>
<li>root=/dev/mmcblk0p2 含义为指定rootfs的位置为TF卡第二个分区</li>
<li>rootfstype=ext4 含义为根文件系统类型</li>
<li>rootwait 含义为等待设备/dev/mmcblk0p2就绪后才尝试挂载rootfs</li>
<li>panic=5 传递内核参数，当遇到panic（内核严重错误）时等待5秒后重启</li>
</ul>
<p>更多的参数可以通过查看Linux内核源码目录下<code>Documentation/kernel-parameters.txt</code>文件了解 </p>
<p>2.第二行和第三行为将<code>script.bin</code>和内核<code>uImage</code>加载到指定内存地址。fatload是U-Boot中装载linux kernel 到内存的指令（这里用到oad）。 </p>
<p>基本用法：fatload &lt;interface&gt; &lt;dev[:part]&gt; &lt;addr&gt; &lt;filename&gt; &lt;bytes&gt; </p>
<ul>
<li>interface：所用到接口，如：MMC、USB</li>
<li>dev [:part]: 文件存放的设备 如：ide 0:1</li>
<li>addr: 装载到内存的开始地址。</li>
<li>filename: 装载的文件名称。</li>
<li>bytes: copy的字节数. </li>
</ul>
<p>3.第四行bootm 用于将内核映像加载到指定的地址 </p>
<p>保存文件后，执行以下命令生成boot.scr： </p>
<pre><code class="bash">mkimage -C none -A arm -T script -d boot.cmd boot.scr
#-C ==&gt; set compression type &#39;comp&#39;
#-A ==&gt; set architecture to &#39;arch&#39;
#-T ==&gt; set image type to &#39;type&#39;
#-d ==&gt; use image data from &#39;datafile&#39;</code></pre>
<h6 id="script-bin是什么"><a href="#script-bin是什么" class="headerlink" title="script.bin是什么"></a>script.bin是什么</h6><p>script.bin是被全志SOC内核驱动或LiveSuit使用的针对特定目标板的二进制配置文件，包含如何设置基于芯片的各种外设，端口，I/O针脚信息。 （相当于设备树，有该信息后就不需要设备树文件了，具体由script.bin还是设备树指定由boot.src中的命令决定）</p>
<p>其对应的可读文本文件格式为FEX，可以利用 Sunxi-tools在二进制和文本文件之间进行转换。更多关于FEX配置的信息可以参考 <a href="http://linux-sunxi.org/Fex_Guide" target="_blank" rel="noopener">http://linux-sunxi.org/Fex_Guide</a></p>
<h6 id="script-bin如何生成"><a href="#script-bin如何生成" class="headerlink" title="script.bin如何生成"></a>script.bin如何生成</h6><p>首先需要编译sunxi-tools，得到<code>fex2bin</code>、<code>bin2fex</code>等文件，其中<code>fex2bin</code>能把 *.fex 文件生成 *.bin文件。反之<code>bin2fex</code>可以将得到的*.bin文件生成可读的*.fex文件。 </p>
<pre><code class="bash">fex2bin sys_config.fex script.bin</code></pre>
<h5 id="2-1-3-分区及下载"><a href="#2-1-3-分区及下载" class="headerlink" title="2.1.3 分区及下载"></a>2.1.3 分区及下载</h5><p>ubuntu上商店中下载 <code>gparted</code> ，利用该软件对SD卡进行格式化并分区</p>
<p>如果SD卡上已经有分区需要先umount卸载文件系统，再格式整个SD卡后才能确保操作无误</p>
<ul>
<li><p>将uboot写入到sd卡8k偏移处：</p>
<pre><code class="bash">  sudo dd if=u-boot-sunxi-with-spl.bin of=/dev/sdb bs=1024 seek=8</code></pre>
</li>
<li><p>建立第一个分区，大小32M（可以随意填写），格式FAT16，把zImage，sun8i-v3s-licheepi-zero.dtb， boot.src（如果有），script.bin（如果有） 拷贝到这个分区</p>
</li>
<li><p>建立第二个分区，用尽剩余空间，格式ext4，把buildroot产生的rootfs.tar解压到该分区根目录</p>
<pre><code class="bash">  sudo tar -xvf output/images/rootfs.tar -C /挂载的tf卡第二个分区目录
  #如：
  sudo tar -xvf output/images/rootfs.tar -C /media/null/rootfs/</code></pre>
</li>
</ul>
<h4 id="2-2-SPI-FLASH"><a href="#2-2-SPI-FLASH" class="headerlink" title="2.2 SPI FLASH"></a>2.2 SPI FLASH</h4><h5 id="分区情况"><a href="#分区情况" class="headerlink" title="分区情况"></a>分区情况</h5><table>
<thead>
<tr>
<th>分区序号</th>
<th>起始地址</th>
<th>长度</th>
<th>镜像名字</th>
<th>内容</th>
</tr>
</thead>
<tbody><tr>
<td>mtd0</td>
<td>0x0</td>
<td>0x0100000(1M)</td>
<td>u-boot-sunxi-with-spl.bin</td>
<td>uboot</td>
</tr>
<tr>
<td>mtd1</td>
<td>0x0100000</td>
<td>0x0010000(64k)</td>
<td>sun8i-v3s-licheepi-zero.dtb</td>
<td>dtb</td>
</tr>
<tr>
<td>mtd2</td>
<td>0x0110000</td>
<td>0x0400000(4M)</td>
<td>zImage</td>
<td>kernel</td>
</tr>
<tr>
<td>mtd3</td>
<td>0x0510000</td>
<td>0x100 0000-0x0510000=0xAF 0000剩余</td>
<td>jffs2.img</td>
<td>rootfs</td>
</tr>
</tbody></table>
<h5 id="生成img镜像"><a href="#生成img镜像" class="headerlink" title="生成img镜像"></a>生成img镜像</h5><pre><code class="bash"># !/bin/sh
#生成一个空文件，大小是32MB
dd if=/dev/zero of=flashimg.bin bs=1M count=32
#将uboot添加到文件开头
dd if=u-boot-sunxi-with-spl.bin of=flashimg.bin bs=1K conv=notrunc
#将dtb放到1M偏移处
dd if=sun8i-v3s-licheepi-zero.dtb of=flashimg.bin bs=1K seek=1024  conv=notrunc
#将kernel放到1M+64K偏移处
dd if=zImage of=flashimg.bin bs=1K seek=1088  conv=notrunc
#将rootfs放到1M+64K+4M偏移处
dd if=jffs2.img of=flashimg.bin  bs=1K seek=5184  conv=notrunc</code></pre>
<p> 执行完毕后生成镜像文件 <em>flashimg.bin</em> </p>
<h5 id="烧写镜像"><a href="#烧写镜像" class="headerlink" title="烧写镜像"></a>烧写镜像</h5><h6 id="安装sunxiflash烧写工具"><a href="#安装sunxiflash烧写工具" class="headerlink" title="安装sunxiflash烧写工具"></a>安装sunxiflash烧写工具</h6><ul>
<li><p>下载</p>
<pre><code class="bash">  git clone -b spi-rebase https://github.com/Icenowy/sunxi-tools.git</code></pre>
</li>
<li><p>编译安装</p>
<pre><code class="bash">  #安装 libusb-1.0-0-dev 以防止报错
  sudo apt-get install libusb-1.0-0-dev
  make &amp;&amp; sudo make install</code></pre>
</li>
</ul>
<h6 id="进入下载（fel）模式"><a href="#进入下载（fel）模式" class="headerlink" title="进入下载（fel）模式"></a>进入下载（fel）模式</h6><p> Zero有一个usb下载模式称为fel模式，进入fel模式有下面几种方式： </p>
<ul>
<li>TF卡和spi flash 同时没有可启动镜像; </li>
<li>TF卡中有进入fel模式的特殊固件 <em>fel-sdboot.sunxi</em> <ul>
<li>如果spiflash已经有了启动镜像，那么需要在TF卡中烧入一个sunxi提供的启动工具 （ <code>dd if=fel-sdboot.sunxi of=/dev/mmcblk0 bs=1024 seek=8</code> ）， 插入TF卡后就会启动会进入fel模式； </li>
</ul>
</li>
<li>上电时SPI_MISO拉低到地（记得松开，否则一直检测不到flash）</li>
</ul>
<h6 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h6><pre><code class="bash">sudo sunxi-fel version              #查看连接的cpu信息
sudo sunxi-fel spiflash-info        #显示flash信息
sudo sunxi-fel -p spiflash-write 0 flashimg.bin #烧写镜像flashimg.bin
# -p 显示进度条
#   spiflash-info                   Retrieves basic information
#   spiflash-hex[dump] addr length  Dumps SPI flash region in hex
#   spiflash-read addr length file  Write SPI flash contents into file
#   spiflash-write addr file        Store file contents into SPI flash
#   clear address length            Clear memory
#   fill address length value       Fill memory</code></pre>
<h6 id="dd命令详解"><a href="#dd命令详解" class="headerlink" title="dd命令详解"></a>dd命令详解</h6><p> dd：用指定大小的块拷贝一个文件，并在拷贝的同时进行指定的转换。 </p>
<ul>
<li><code>if</code>=文件名：输入文件名，缺省为标准输入。即指定源文件。&lt;if=inputfile&gt;</li>
<li><code>of</code>=文件名：输出文件名，缺省为标准输出。即指定目的文件。&lt; of=output file &gt;</li>
<li>ibs=bytes：一次读入bytes个字节，即指定一个块大小为bytes个字节。<br>  obs=bytes：一次输出bytes个字节，即指定一个块大小为bytes个字节。<br>  <code>bs</code>=bytes：同时设置读入/输出的块大小为bytes个字节。</li>
<li>cbs=bytes：一次转换bytes个字节，即指定转换缓冲区大小。</li>
<li>skip=blocks：从输入文件开头跳过blocks个块后再开始复制。</li>
<li><code>seek</code>=blocks：从输出文件开头跳过blocks个块后再开始复制。<br>  （注意：通常只用当输出文件是磁盘或磁带时才有效，即备份到磁盘或磁带时才有效。</li>
<li><code>count</code>=blocks：仅拷贝blocks个块，块大小等于ibs指定的字节数。</li>
<li>conv=conversion：用指定的参数转换文件。<ul>
<li>ascii：转换ebcdic为ascii</li>
<li>ebcdic：转换ascii为ebcdic</li>
<li>ibm：转换ascii为alternateebcdic</li>
<li>block：把每一行转换为长度为cbs，不足部分用空格填充</li>
<li>unblock：使每一行的长度都为cbs，不足部分用空格填充</li>
<li>lcase：把大写字符转换为小写字符</li>
<li>ucase：把小写字符转换为大写字符</li>
<li>swab：交换输入的每对字节</li>
<li>noerror：出错时不停止</li>
<li>notrunc：不截短输出文件</li>
<li>sync：将每个输入块填充到ibs个字节，不足部分用空（NUL）字符补齐。</li>
</ul>
</li>
</ul>
<h6 id="dev-null和-dev-zero的区别"><a href="#dev-null和-dev-zero的区别" class="headerlink" title="/dev/null和/dev/zero的区别"></a>/dev/null和/dev/zero的区别</h6><ul>
<li><code>/dev/null</code>，外号叫无底洞，你可以向它输出任何数据，它通吃，并且不会撑着！ </li>
<li><code>/dev/zero</code>，是一个输入设备，你可你用它来初始化文件。该设备无穷尽地提供0，可以使用任何你需要的数目——设备提供的要多的多。他可以用于向设备或文件写入字符串0。 </li>
</ul>
<h2 id="二、开发环境搭建"><a href="#二、开发环境搭建" class="headerlink" title="二、开发环境搭建"></a>二、开发环境搭建</h2><p>Root用户： </p>
<pre><code class="bash">用户名: root
密码: 55555</code></pre>
<p>存储空间查看</p>
<pre><code class="bash">df -h
du -h 要查看的文件夹或文件</code></pre>
<h3 id="rtl8723bs无线网卡搭建"><a href="#rtl8723bs无线网卡搭建" class="headerlink" title="rtl8723bs无线网卡搭建"></a>rtl8723bs无线网卡搭建</h3><p>前提条件：</p>
<ul>
<li><code>rtl8723bs_nic.bin</code>wifi固件</li>
<li>wifi工具库</li>
<li><code>r8723bs.ko</code>驱动（4.13主线内核自带，默认以模块方式安装）</li>
</ul>
<p>步骤：</p>
<ul>
<li><p><code>ifconfig -a</code>命令查看当前系统中的全部网卡</p>
</li>
<li><p>安装驱动后执行 <code>ifconfig wlan0 up</code>  启动网卡</p>
</li>
<li><p>修改或创建配置文件 <code>/etc/wpa_supplicant.conf</code> </p>
<pre><code class="bash">  ctrl_interface=/var/run/wpa_supplicant 
  ctrl_interface_group=0 
  ap_scan=1 
  network={
      #wifi名字
      ssid=&quot;debugdump&quot;
      scan_ssid=1
      key_mgmt=WPA-EAP WPA-PSK IEEE8021X NONE
      pairwise=TKIP CCMP
      group=CCMP TKIP WEP104 WEP40
      #wifi秘密
      psk=&quot;13800138000&quot;
      priority=5
  }</code></pre>
</li>
<li><p>使能配置<code>wpa_supplicant -B -d -i wlan0 -c /etc/wpa_supplicant.conf</code></p>
</li>
<li><p>开启wifi<code>udhcpc -i wlan0</code></p>
</li>
</ul>
<h2 id="三、移植OPENCV（3-4-1）"><a href="#三、移植OPENCV（3-4-1）" class="headerlink" title="三、移植OPENCV（3.4.1）"></a>三、移植OPENCV（3.4.1）</h2><p>默认使用的是6.3.1的gcc</p>
<p>下载烧录V3s_linux_4_2_0_ov2640_debugdump.bin镜像</p>
<pre><code class="bash">sudo dd of=/dev/sdX if=V3s_linux_4_2_0_ov2640_debugdump.bin</code></pre>
<p>用户名root，密码root</p>
<p>该镜像中rootfs只有90M左右，需要用到linux主机下gparted 软件将rootfs进行扩展</p>
<p>测试相机</p>
<pre><code class="bash">#ov2640可用
fswebcam -d /dev/video0 --no-banner -p UYVY -S 10 -r 800x600 capture.jpg
#-d配置使用哪个摄像设备
#–no-banner不添加水印
#-p摄像头输出格式
#-r图片大小（本人手上的ov2640貌似只支持800x600的格式）
#-S曝光度设置，越大越不刺眼

#开启web服务器
mjpg_streamer -i &quot;input_uvc.so -d /dev/video0 -r 640x480&quot; -o &quot;output_http.so -p 8080 -w /usr/local/share/mjpg-streamer/www&quot;
mjpg_streamer -i &quot;input_uvc.so -f 10 -r 320*240 -y&quot; -o &quot;output_http.so -c &quot;ruoyun:liufeng&quot; -w www -p 8888&quot; -o &quot;output_file.so -d 1000 -f /mnt &quot;

mjpg_streamer -i &quot;input_uvc.so -d /dev/video0 -r QVGA&quot; -o &quot;output_http.so -p 8080 -w /usr/local/www&quot;</code></pre>
<h3 id="配置编译OPENCV"><a href="#配置编译OPENCV" class="headerlink" title="配置编译OPENCV"></a>配置编译OPENCV</h3><ul>
<li><p>linux主机下打开cmake的gui</p>
<pre><code class="bash">  sudo cmake-gui</code></pre>
</li>
<li><p>填写配置信息</p>
<ul>
<li>取消<code>WITH_GTK</code></li>
<li>取消<code>WITH_TIFF</code></li>
<li>修改安装路径<code>CMAKE_INSTALL_PREFIX</code>为/home/null/Code/OpenCV/install_opencv</li>
<li>配置 <code>CMAKE_EXE_LINKER_FLAGS</code> 为 -lpthread -lrt -ldl </li>
<li>其他详见<a href="https://blog.csdn.net/Guet_Kite/article/details/78667175" target="_blank" rel="noopener">https://blog.csdn.net/Guet_Kite/article/details/78667175</a></li>
</ul>
</li>
<li><p><code>sudo make</code>编译 </p>
</li>
<li><p><code>make install</code>将opencv编译出的库文件安装到CMAKE_INSTALL_PREFIX设置的目录下</p>
</li>
<li><p>将安装目录下的/lib/下的所有lib文件拷贝至开发板/lib下</p>
<pre><code class="bash">  cp -a /home/null/Code/OpenCV/nfs_code/opencvlib/* /home/null/Code/LiCheePi_Zero/Image/cam_image/rootfs/lib
  #-a ：相当于 -pdr 的意思（参数pdr分别为：保留权限，复制软链接本身，递归复制）；
  #-p ：连同档案的属性一起复制过去，而非使用预设属性；
  #-d ：若来源文件为连结文件的属性(link file)，则复制连结文件属性而非档案本身；
  #-r ：递归持续复制，用于目录的复制行为；</code></pre>
</li>
</ul>
<h3 id="OPENCV开发"><a href="#OPENCV开发" class="headerlink" title="OPENCV开发"></a>OPENCV开发</h3><p><strong>makefile</strong></p>
<pre><code class="makefile">CC  = arm-linux-gnueabihf-g++
LFLAGS  = -Wno-psabi
#lib库位置
LIBS    = -L/home/null/Code/OpenCV/install_opencv/lib/
#各种库
#-libopencv_imgcodecs -lopencv_features2d -std=c++11 -fopenmp
CPPFLAGS    = -lpthread -lopencv_core -lopencv_highgui -lrt -lopencv_imgproc -lopencv_imgcodecs
#包含的头文件目录
LINC     += -I/home/null/Code/OpenCV/install_opencv/include/
#输入文件名
objs := opencv
out := opencv

$(out):$(objs).cpp
    ${CC} ${LFLAGS} ${LIBS} ${LINC} ${CPPFLAGS} -o $@ $^
clean:
    rm $(out)</code></pre>
<p><strong>测试文件</strong></p>
<pre><code class="c++">#include&lt;opencv2/core/core.hpp&gt;  
#include&lt;opencv2/highgui/highgui.hpp&gt;  
#include&lt;opencv2/opencv.hpp&gt; 
#include&lt;iostream&gt;

using namespace cv;  
using namespace std;

int main( )  
{   
    //载入图片  
    Mat image= imread(&quot;girl.jpg&quot;);  
    Mat logo= imread(&quot;fly.jpg&quot;);   
    //定义一个Mat类型，用于存放，图像的ROI  
    Mat imageROI;

    imageROI= image(Rect(10,10,logo.cols,logo.rows));//定义一个左上角点坐标为(_x, _y)的cols*rows矩形窗口

    //将logo加到原图
    //参数：图、权重、图、权重、添加的常数项、输出图
    addWeighted(imageROI,0.5,logo,0.3,0.,imageROI);     

    cout &lt;&lt; &quot;start add picture......\n&quot; &lt;&lt; endl;    
    //输出一张jpg图片到工程目录下  
    imwrite(&quot;fly_girl.jpg&quot;,image);  

    //waitKey();  

    return 0;  
}</code></pre>
<ul>
<li>由于编译的时候没有加入<code>WITH_GTK</code>选项，因而在板卡上执行的程序无法使用函数<code>imshow</code>、<code>waitKey</code>等函数。 </li>
</ul>
<p>上面例子中的girl.jpg：</p>
<p><img src="//NU-LL.github.io/2019/10/18/LiCheePi_Zero底层开发/girl.jpg" alt="girl"></p>
<p>fly.jpg：</p>
<p><img src="//NU-LL.github.io/2019/10/18/LiCheePi_Zero底层开发/fly.jpg" alt="fly"></p>
<p>合成后的图片：</p>
<p><img src="//NU-LL.github.io/2019/10/18/LiCheePi_Zero底层开发/fly_girl.jpg" alt="fly_girl"></p>
<h2 id="四、驱动编写"><a href="#四、驱动编写" class="headerlink" title="四、驱动编写"></a>四、驱动编写</h2><p>暂时采用官方镜像，镜像名字为<code>nanopi-neo-core_sd_friendlycore-xenial_4.14_armhf_20190823.img</code>，该镜像中采用的rootfs为<code>UbuntuCore 18.04</code></p>
<h3 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h3><h4 id="内核版本查看方法"><a href="#内核版本查看方法" class="headerlink" title="内核版本查看方法"></a>内核版本查看方法</h4><pre><code class="bash">cat /proc/version
uname -a</code></pre>
<h4 id="挂载pc上文件系统"><a href="#挂载pc上文件系统" class="headerlink" title="挂载pc上文件系统"></a>挂载pc上文件系统</h4><pre><code class="bash">mount -t nfs -o nolock 192.168.2.101:/home/null/Code/NanoPi_NEO_Core/nfs /mnt

mount -t nfs -o nolock 192.168.2.101:/home/null/nfs_root /mnt
mount -t nfs -o nolock 192.168.2.101:/home/null/Code/OpenCV/nfs_code /mnt
mount -t nfs -o nolock 192.168.2.101:/home/null/Code/LiCheePi_Zero/nfs /mnt</code></pre>
<p>挂载报错尝试安装<code>nfs-common</code></p>
<blockquote>
<p>报错：</p>
<pre><code class="bash">mount: wrong fs type, bad option, bad superblock on 192.168.2.101:/home/null/nfs_root,
       missing codepage or helper program, or other error
       (for several filesystems (e.g. nfs, cifs) you might
       need a /sbin/mount.&lt;type&gt; helper program)

       In some cases useful info is found in syslog - try
       dmesg | tail or so.</code></pre>
<p>安装nfs-common：</p>
<pre><code class="bash">sudo apt-get install nfs-common</code></pre>
</blockquote>
<p>pc端检查是否配置成功（自己挂接自己）（绝对路径）</p>
<pre><code class="bash">sudo mount -t nfs -o nolock localhost://home/null/Code/NanoPi_NEO_Core/nfs /mnt/nfs#挂接
sudo mount -t nfs -o nolock localhost://home/null/nfs_root /mnt/nfs_root#挂接
ls -l /mnt/nfs#检查
ls -l /mnt/nfs_root#检查
sudo umount /mnt/nfs#卸载
sudo umount /mnt/nfs_root#卸载</code></pre>
<h5 id="一键挂载脚本"><a href="#一键挂载脚本" class="headerlink" title="一键挂载脚本"></a>一键挂载脚本</h5><pre><code class="bash">#!/bin/bash
if [ $(id -u) -ne 0 ]; then
    echo &quot;Re-running script under sudo...&quot;
    sudo &quot;$0&quot; &quot;$@&quot;
    exit
fi
mount -t nfs -o nolock 192.168.2.101:/home/null/Code/NanoPi_NEO_Core/nfs /mnt
echo &quot;mount -&gt; /mnt&quot;</code></pre>
<p>记得chmod +x </p>
<h5 id="卸载脚本"><a href="#卸载脚本" class="headerlink" title="卸载脚本"></a>卸载脚本</h5><pre><code class="bash">#!/bin/bash
if [ $(id -u) -ne 0 ]; then
    echo &quot;Re-running script under sudo...&quot;
    sudo &quot;$0&quot; &quot;$@&quot;
    exit
fi
umount /mnt
echo &quot;umount /mnt OK&quot;</code></pre>
<p>记得chmod +x </p>
<h4 id="更换源"><a href="#更换源" class="headerlink" title="更换源"></a>更换源</h4><p>参考： <a href="http://mirrors.ustc.edu.cn/help/ubuntu-ports.html" target="_blank" rel="noopener">http://mirrors.ustc.edu.cn/help/ubuntu-ports.html</a></p>
<p>修改 <code>/etc/apt/sources.list</code> 文件中镜像源服务器地址 <a href="http://ports.ubuntu.com/" target="_blank" rel="noopener">http://ports.ubuntu.com/</a> 为 <a href="http://mirrors.ustc.edu.cn/ubuntu-ports/" target="_blank" rel="noopener">http://mirrors.ustc.edu.cn/ubuntu-ports/</a></p>
<pre><code class="bash">deb http://mirrors.ustc.edu.cn/ubuntu-ports/ bionic main restricted universe multiverse
#deb http://ports.ubuntu.com/ bionic main restricted universe multiverse
# deb-src http://ports.ubuntu.com/ xenial main restricted universe multiverse

deb http://mirrors.ustc.edu.cn/ubuntu-ports/ bionic-security main restricted universe multiverse
#deb http://ports.ubuntu.com/ bionic-security main restricted universe multiverse
# deb-src http://ports.ubuntu.com/ xenial-security main restricted universe multiverse

deb http://mirrors.ustc.edu.cn/ubuntu-ports/ bionic-updates main restricted universe multiverse
#deb http://ports.ubuntu.com/ bionic-updates main restricted universe multiverse
# deb-src http://ports.ubuntu.com/ xenial-updates main restricted universe multiverse

deb http://mirrors.ustc.edu.cn/ubuntu-ports/ bionic-backports main restricted universe multiverse
#deb http://ports.ubuntu.com/ bionic-backports main restricted universe multiverse
# deb-src http://ports.ubuntu.com/ xenial-backports main restricted universe multiverse</code></pre>
<p>更新源：</p>
<pre><code class="bash">sudo apt update</code></pre>
<h3 id="1-按键驱动程序"><a href="#1-按键驱动程序" class="headerlink" title="1.按键驱动程序"></a>1.按键驱动程序</h3><h4 id="1-1修改设备树"><a href="#1-1修改设备树" class="headerlink" title="1.1修改设备树"></a>1.1修改设备树</h4><h5 id="编译设备树"><a href="#编译设备树" class="headerlink" title="编译设备树"></a>编译设备树</h5><pre><code class="bash">make dtbs ARCH=arm CROSS_COMPILE=arm-linux- -j8</code></pre>
<h5 id="查看系统中是否存在对应节点"><a href="#查看系统中是否存在对应节点" class="headerlink" title="查看系统中是否存在对应节点"></a>查看系统中是否存在对应节点</h5><pre><code class="bash">ls /proc/device-tree/

cat /proc/device-tree/key/compatible

# 注意：hexdump查看的是dtb文件原始数据，其中的数据是按照大字节序排放的（低地址放高位）
hexdump /proc/device-tree/key/key-gpio
busybox hexdump /proc/device-tree/key/key-gpio</code></pre>
<h5 id="设备树中的GPIO节点"><a href="#设备树中的GPIO节点" class="headerlink" title="设备树中的GPIO节点"></a>设备树中的GPIO节点</h5><p>假设PA6和PA7上接入两个LED，通过编写一个GPIO的驱动程序来控制LED的亮灭，在设备树文件sun8i-h3-nanopi-m1.dts的根节点增加一个myleds子节点  ：</p>
<pre><code>myleds {       
    compatible = &quot;usr,myleds&quot;;         
    led-gpios = &lt;&amp;pio 0  7  GPIO_ACTIVE_HIGH&gt;,&lt;&amp;pio 0  6  GPIO_ACTIVE_HIGH&gt;;/* 0表示PA组的io口, 因h3里第0组的io口就是以PA开始命名的 */          
};</code></pre><p> 节点中的led-gpios属性，引用了pinctrl信息，sunxi-h3-h5.dtsi中有关于该控制器的描述， </p>
<pre><code>pio: pinctrl@01c20800 {
    /* compatible is in per SoC .dtsi file */
    reg = &lt;0x01c20800 0x400&gt;;
    interrupts = &lt;GIC_SPI 11 IRQ_TYPE_LEVEL_HIGH&gt;,
    &lt;GIC_SPI 17 IRQ_TYPE_LEVEL_HIGH&gt;;
    clocks = &lt;&amp;ccu CLK_BUS_PIO&gt;, &lt;&amp;osc24M&gt;, &lt;&amp;osc32k&gt;;
    clock-names = &quot;apb&quot;, &quot;hosc&quot;, &quot;losc&quot;;
    gpio-controller;
    #gpio-cells = &lt;3&gt;;
    interrupt-controller;
    #interrupt-cells = &lt;3&gt;;
    ......
};</code></pre><p>myleds子节点描述了两个GPIO信息，具有多个gpio口信息的属性值: <code>&lt;&amp;gpio控制器节点名 具体gpio口的标识符&gt;,&lt;&amp;gpio控制器节点名 具体gpio口的标识符&gt; …;</code>具体gpio口的标识符是由多个数字组成, 数字的个数由所用的gpio控制器节点里的#gpio-cells属性值指定.。全志H3 共有七组GPIO ，也即七个bank，分别为PA (PA0-21),PC(PC0-16) PD (PD0-17), PE(PE0-15),PF(PF0-6) PG(PG0-13) ,PL(PL0-PL11),在内核中PA-PG是一个pinctrl控制器，而PL是另一个pinctrl控制器 。</p>
<p>由#gpio-cells = &lt;3&gt;可以推出GPIO属性需要用3个u32的数据描述，第一个参数代表该GPIO位于哪个bank，第二个参数代表该bank下的序号，第三个参数代表默认电平，myleds节点下的GPIO_ACTIVE_HIGH这个宏就定义于include/dt-bindings/gpio/gpio.h</p>
<h4 id="1-2编写驱动"><a href="#1-2编写驱动" class="headerlink" title="1.2编写驱动"></a>1.2编写驱动</h4><h5 id="1-2-1检查注册的驱动"><a href="#1-2-1检查注册的驱动" class="headerlink" title="1.2.1检查注册的驱动"></a>1.2.1检查注册的驱动</h5><ul>
<li><p>驱动安装好后，会在<code>/dev/</code>目录下创建同名目录</p>
</li>
<li><p>或者通过<code>cat /proc/devices</code>命令查看多出来的驱动</p>
</li>
</ul>
<h5 id="1-2-2gpiolib及gpio操作"><a href="#1-2-2gpiolib及gpio操作" class="headerlink" title="1.2.2gpiolib及gpio操作"></a>1.2.2gpiolib及gpio操作</h5><h6 id="经典接口"><a href="#经典接口" class="headerlink" title="经典接口"></a>经典接口</h6><ul>
<li><code>gpio_request</code>:驱动中要想使用某一个gpio，就必须先调用gpio_request接口来向内核申请，得到允许后才可以去使用这个gpio</li>
<li><code>gpio_free</code>: 对应gpio_request，用来释放申请后用完了的gpio</li>
<li><code>gpiochip_is_requested</code>: 接口用来判断某一个gpio是否已经被申请了</li>
<li><code>gpio_direction_input</code>/<code>gpio_direction_output</code>: 接口用来设置GPIO为输入/输出模式（不推荐直接设置寄存器）</li>
</ul>
<blockquote>
<ul>
<li>一般来说，gpio的资源申请和释放操作应该放在驱动模块的加载与卸载函数内</li>
<li>gpio_request的第一个参数是需要申请的gpio号。第二个参数是我们给该gpio起个名字</li>
<li>申请完了之后对这个gpio进行模式设置，我们这里用gpio_direction_output 设置成输出模式，并且默认输出1让led灭 </li>
</ul>
</blockquote>
<h6 id="新接口"><a href="#新接口" class="headerlink" title="新接口"></a>新接口</h6><ul>
<li><code>devm_gpio_request_one</code>： 自带初始化电平功能，并且会在模块卸载时自动释放gpio，十分简便 </li>
</ul>
<h6 id="读写gpio"><a href="#读写gpio" class="headerlink" title="读写gpio"></a>读写gpio</h6><ul>
<li><code>gpio_get_value</code>：读gpio</li>
<li><code>gpio_set_value</code>：写gpio</li>
</ul>
<h6 id="控制台中查看当前gpio占用情况的方法"><a href="#控制台中查看当前gpio占用情况的方法" class="headerlink" title="控制台中查看当前gpio占用情况的方法"></a>控制台中查看当前gpio占用情况的方法</h6><p>内核中提供了虚拟文件系统debugfs，里面有一个gpio文件，提供了gpio的使用信息</p>
<ul>
<li>使用 <code>mount -t debugfs debugfs /tmp</code> 把debugfs挂接到/tmp下，再重新进入/tmp后就能看到一个名为gpio的文件</li>
<li><code>cat /tmp/gpio</code>即可得到gpio的所有信息，使用完后<code>umount /tmp</code>卸载掉debugfs</li>
</ul>
<h4 id="1-3调试"><a href="#1-3调试" class="headerlink" title="1.3调试"></a>1.3调试</h4><h5 id="printk"><a href="#printk" class="headerlink" title="printk"></a>printk</h5><ul>
<li><p>查看<code>printk</code>输出的日志：</p>
<p>  通过<code>dmesg</code>和 <code>more</code>、<code>tail</code>、<code>less</code>、<code>grep</code>的结合查看日志</p>
<pre><code class="bash">#输出全部信息
dmesg
#输出前20行
dmesg | head -20
#输出后20行
dmesg | tail -20
#输出包含usb的信息（-i：忽略大小写）
dmesg | grep -i usb
#清空dmesg环形缓冲区中的日志
dmesg -c
    ```</code></pre>
</li>
<li><p>或者直接设置日志的输出的等级：</p>
<pre><code class="bash">  echo $level &gt; /proc/sys/kernel/printk#默认为4 4 1 7
  #如：
  echo 8 4 1 7 &gt; /proc/sys/kernel/printk#所有级别日志均可打印输出</code></pre>
<blockquote>
<p>/proc/sys/kernel/printk中对应的四个数分别对应于：</p>
<ul>
<li><p>①控制台日志级别：优先级高于该值的消息将被打印至控制台。</p>
</li>
<li><p>②缺省的消息日志级别：将用该值来打印没有优先级的消息。</p>
</li>
<li><p>③最低的控制台日志级别：控制台日志级别可能被设置的最小值。</p>
</li>
<li><p>④缺省的控制台：控制台日志级别的缺省值。</p>
<p>日志缓冲区的每一行文本开头具有级别标记, 级别值<strong>越小</strong>则优先级<strong>越高</strong>.  </p>
<p>系统定义了8个消息级别, 级别号从0到7分别为：</p>
</li>
<li><p>致命级(KERN_EMESG), </p>
</li>
<li><p>警戒级(KERN_ALERT), </p>
</li>
<li><p>临界级(KERN_CRIT),</p>
</li>
<li><p>错误级(KERN_ERR), </p>
</li>
<li><p>告警级(KERN_WARN), </p>
</li>
<li><p>注意级(KERN_NOTICE), </p>
</li>
<li><p>通知级(KERN_INFO),</p>
</li>
<li><p>调试级(KERN_DEBUG).</p>
</li>
</ul>
</blockquote>
</li>
</ul>
<h5 id="后台运行"><a href="#后台运行" class="headerlink" title="后台运行"></a>后台运行</h5><ul>
<li><p>&amp;</p>
<p>   当在前台运行某个作业时，终端被该作业占据；可以在命令后面加上&amp; 实现后台运行。例如：sh test.sh &amp;</p>
<p>  当成功地提交进程以后，就会显示出一个进程号，可以用它来监控该进程，或杀死它。(<code>ps -ef | grep 进程号</code> 或者 <code>kill -9 进程号</code>）</p>
</li>
<li><p>nohup  </p>
<p> 使用&amp;命令后，作业被提交到后台运行，当前控制台没有被占用，但是一但把当前控制台关掉(退出帐户时)，作业就会停止运行。nohup命令可以在你退出帐户之后继续运行相应的进程。nohup就是不挂起的意思( no hang up)。该命令的一般形式为：</p>
<pre><code class="bash"> nohup command &amp;</code></pre>
<p> 如果使用nohup命令提交作业，那么在缺省情况下该作业的所有输出都被重定向到一个名为nohup.out的文件中，除非另外指定了输出文件：</p>
<pre><code class="bash"> nohup command &gt; myout.file 2&gt;&amp;1 &amp;</code></pre>
<p> 使用了nohup之后，很多人就这样不管了，其实这样有可能在当前账户非正常退出或者结束的时候，命令还是自己结束了。所以在使用nohup命令后台运行命令之后，需要使用exit正常退出当前账户，这样才能保证命令一直在后台运行。</p>
</li>
<li><p>ctrl + z </p>
<p> 可以将一个正在前台执行的命令放到后台，并且处于暂停状态。 </p>
</li>
<li><p>jobs<br>  查看当前有多少在后台运行的命令。<br>  <code>jobs -l</code>选项可显示所有任务的PID，jobs的状态可以是running, stopped, Terminated。但是如果任务被终止了（kill），shell 从当前的shell环境已知的列表中删除任务的进程标识。 </p>
</li>
</ul>
<h3 id="2-内核定时器"><a href="#2-内核定时器" class="headerlink" title="2.内核定时器"></a>2.内核定时器</h3><h3 id="3-中断"><a href="#3-中断" class="headerlink" title="3.中断"></a>3.中断</h3><h4 id="上半部和下半部"><a href="#上半部和下半部" class="headerlink" title="上半部和下半部"></a>上半部和下半部</h4><ul>
<li><p>软中断</p>
<p>  软中断必须在编译的时候静态注册</p>
<ul>
<li>open_sotfirq：打开软中断</li>
<li>raise_sotfirq：触发软中断</li>
</ul>
</li>
<li><p>tasklet：利用软中断来实现的另一种下半部机制，在软中断和tasklet之间建议选tasklet</p>
<ul>
<li>tasklet_init：初始化tasklet_struct结构体，或直接使用宏DECLARE_TASKLET定义＋初始化</li>
<li>tasklet_schedule：一般在上半部中调用，使要调度的tasklet在合适的时候运行</li>
</ul>
</li>
<li><p>工作队列：在<strong>进程</strong>上下文执行，允许睡眠或重新调度（下半部可以睡眠就可以交给工作队列），要执行的工作会交给一个内核工作者线程去执行</p>
<ul>
<li>宏INIT_WORK：初始化工作</li>
<li>宏DECLARE_WORK：定义+初始化工作</li>
<li>schedule_work：类似tasklet_schedule，调度传入的工作</li>
</ul>
</li>
</ul>
<h4 id="3-1修改设备树"><a href="#3-1修改设备树" class="headerlink" title="3.1修改设备树"></a>3.1修改设备树</h4><p>参考内核绑定信息：Documentation/devicetree/bindings/arm/gic.txt</p>
<p>对于一般的ARM处理器来说，<code>#interrupt-cells=&lt;3&gt;</code>对应的三个cell分别为：</p>
<ol>
<li>中断类型<ul>
<li>0：SPI中断</li>
<li>1：PPI中断</li>
</ul>
</li>
<li>中断号<ul>
<li>SPI：0~987</li>
<li>PPI：0~15</li>
</ul>
</li>
<li>标志<ul>
<li>bit[3:0]：中断触发类型<ul>
<li>1：上升沿</li>
<li>2：下降沿</li>
<li>4：高电平</li>
<li>8：低电平</li>
</ul>
</li>
<li>bit[15:8]：PPI中断的CPU掩码</li>
</ul>
</li>
</ol>
<h5 id="相关函数"><a href="#相关函数" class="headerlink" title="相关函数"></a>相关函数</h5><ul>
<li>irq_of_parse_and_map：从设备树中中断节点中的interrupts属性提取对应的中断号</li>
<li>gpio_to_irq：获取gpio对应的中断号</li>
</ul>
<h5 id="编译设备树-1"><a href="#编译设备树-1" class="headerlink" title="编译设备树"></a>编译设备树</h5><pre><code class="bash">make dtbs ARCH=arm CROSS_COMPILE=arm-linux- -j8</code></pre>
<h5 id="查看系统中是否存在对应节点-1"><a href="#查看系统中是否存在对应节点-1" class="headerlink" title="查看系统中是否存在对应节点"></a>查看系统中是否存在对应节点</h5><pre><code class="bash">ls /proc/device-tree/

cat /proc/device-tree/key/compatible

# 注意：hexdump查看的是dtb文件原始数据，其中的数据是按照大字节序排放的（低地址放高位）
hexdump /proc/device-tree/key/interrupts
busybox hexdump /proc/device-tree/key/interrupts</code></pre>
<h5 id="设备树中的中断节点"><a href="#设备树中的中断节点" class="headerlink" title="设备树中的中断节点"></a>设备树中的中断节点</h5><ul>
<li>interrupt-parent = &lt;&amp;pio&gt;;//属于pio中断控制器</li>
<li>interrupts = &lt;0 7 IRQ_TYPE_EDGE_BOTH&gt;;<ul>
<li>第一个参数：第几个GPIO（这里是GPIOA）</li>
<li>第二个参数：第几个外部中断</li>
<li>第三个参数：触发沿</li>
</ul>
</li>
</ul>
<h4 id="3-2编写驱动"><a href="#3-2编写驱动" class="headerlink" title="3.2编写驱动"></a>3.2编写驱动</h4><h4 id="3-3调试"><a href="#3-3调试" class="headerlink" title="3.3调试"></a>3.3调试</h4><p>中断注册成功后可以通过以下命令来查看是否注册到系统中：</p>
<pre><code class="bash">cat /proc/interrupts</code></pre>
<h3 id="4-input子系统"><a href="#4-input子系统" class="headerlink" title="4.input子系统"></a>4.input子系统</h3><h4 id="4-1修改设备树"><a href="#4-1修改设备树" class="headerlink" title="4.1修改设备树"></a>4.1修改设备树</h4><p>如果需要使用内核自带的<code>gpio_keys.c</code>驱动，可以参考内核中<code>Documentation/devicetree/bindings/input/gpio-keys.txt</code>，需要设备树中的节点满足以下要求：</p>
<ul>
<li><p>节点名字为<code>“gpio-keys”</code></p>
</li>
<li><p>gpio-keys节点的compatible属性必须为<code>“gpio-keys”</code></p>
</li>
<li><p>所有的按键都是gpio-keys的子节点，并可以使用如下属性描述自己：</p>
<ul>
<li>gpios：按键连接的gpio信息</li>
<li>interrupts：按键使用的中断信息（可选）</li>
<li>lable：按键名字</li>
<li>linux,code：要模拟的按键值</li>
</ul>
</li>
<li><p>如果要支持连按的话需要加入<code>autorepeat</code>属性</p>
<p>  例子：</p>
<pre><code>  gpio_keys {
      compatible = &quot;gpio-keys&quot;;
      autorepeat;//支持连按
      k1 {
          label = &quot;k1&quot;;//按键名称
          linux,code = &lt;KEY_POWER&gt;;//要模拟的按键值
          gpios = &lt;&amp;pio 0 7 GPIO_ACTIVE_LOW&gt;;//按键连接的gpio信息
          interrupts = &lt;0 7 IRQ_TYPE_EDGE_BOTH&gt;;//中断信息 PA7 --&gt; EINT7
      };
  };</code></pre></li>
</ul>
<h4 id="4-2编写驱动"><a href="#4-2编写驱动" class="headerlink" title="4.2编写驱动"></a>4.2编写驱动</h4><p>Linux中已经实现了input输入子系统框架，因此无需再次注册设备，系统中input框架中的所有设备的主设备号均为13</p>
<ul>
<li>input设备结构体<code>input_dev</code><ul>
<li>evbit成员：输入事件类型，可选事件见下文</li>
<li>keybit成员：按键值</li>
<li>relbit成员：相对坐标</li>
<li>absbit成员：绝对坐标</li>
<li>…</li>
</ul>
</li>
</ul>
<p>设置input_dev结构体中成员的方法：</p>
<ul>
<li>__set_bit</li>
<li>BIT_MASK宏</li>
<li>input_set_capability：仅仅设置keybit成员</li>
</ul>
<h5 id="相关函数-1"><a href="#相关函数-1" class="headerlink" title="相关函数"></a>相关函数</h5><ul>
<li>input_allocate_device：申请一个input_dev结构体</li>
<li>input_free_device：释放申请到的input_dev结构体</li>
<li>input_register_device：向内核注册input_dev结构体</li>
<li>input_unregister_device：注销input_dev结构体</li>
<li>input_event：上报指定事件及对应的值<ul>
<li>input_report_key：封装一层，专门上报按键事件</li>
<li>input_report_rel</li>
<li>input_report_abs</li>
<li>input_report_ff_status</li>
<li>input_report_switch</li>
<li>input_mt_sync</li>
</ul>
</li>
<li>input_sync：同步事件</li>
</ul>
<h5 id="input-dev的相关事件"><a href="#input-dev的相关事件" class="headerlink" title="input_dev的相关事件"></a>input_dev的相关事件</h5><ul>
<li>EV_SYN：同步</li>
<li>EV_KEY：按键</li>
<li>EV_REL：相对坐标</li>
<li>EV_ABS：绝对坐标</li>
<li>EV_MSC：杂项（其他）</li>
<li>EV_SW：开关</li>
<li>EV_LED：LED</li>
<li>EV_SND：声音（sound）</li>
<li>EV_REP：重复事件</li>
<li>EV_FF：压力</li>
<li>EV_PWR：电源</li>
<li>EV_FF_STATUS：压力状态</li>
</ul>
<h4 id="4-3调试"><a href="#4-3调试" class="headerlink" title="4.3调试"></a>4.3调试</h4><p>input设备注册成功后可以通过以下命令来查看是否注册到系统中：</p>
<pre><code class="bash">ls /dev/input/ -l</code></pre>
<p>通过以下命令查看是否有效：</p>
<pre><code>busybox hexdump /dev/input/event1</code></pre><h3 id="5-IIC框架驱动"><a href="#5-IIC框架驱动" class="headerlink" title="5.IIC框架驱动"></a>5.IIC框架驱动</h3><h4 id="5-1设备树"><a href="#5-1设备树" class="headerlink" title="5.1设备树"></a>5.1设备树</h4><ul>
<li><code>clock-frequency</code>属性：iic总线的速度（默认100000，即100k）</li>
<li>status：是否使能该总线<ul>
<li>okay</li>
<li>disabled</li>
</ul>
</li>
<li>iic设备节点需要写到iic总线节点中，作为总线节点的子节点</li>
<li>总线节点需要利用<code>pinctrl-names = &quot;default&quot;;</code>和<code>pinctrl-0</code>指定iic引脚（已经设置好）</li>
<li>iic控制器节点<code>compatible</code>属性必须为allwinner,sun6i-a31-i2c或allwinner,sun4i-a10-i2c，这里在sunxi-h3-h5.dtsi中已经设置好，无需再次设置</li>
</ul>
<p>设备树修改成功后可以通过以下命令来查看是否注册到系统中：</p>
<pre><code class="bash">#查看设备节点，该目录下放着所有的i2c设备
#节点是以i2c地址结尾的文件夹
ls /sys/bus/i2c/devices/</code></pre>
<h4 id="5-2驱动"><a href="#5-2驱动" class="headerlink" title="5.2驱动"></a>5.2驱动</h4><h5 id="基本数据结构"><a href="#基本数据结构" class="headerlink" title="基本数据结构"></a>基本数据结构</h5><ul>
<li>IIC总线结构体<code>i2c_bus_type</code><ul>
<li>match函数：驱动和设备匹配是调用该函数来决定是否匹配</li>
</ul>
</li>
<li>IIC适配器（控制器）驱动结构体<code>i2c_adapter</code><ul>
<li>algo：总线访问算法成员<ul>
<li>master_xfer：IIC适配器的传输函数</li>
<li>smbus_xfer：SMBUS总线传输函数</li>
</ul>
</li>
</ul>
</li>
<li>IIC设备结构体<code>i2c_client</code><ul>
<li>addr：芯片地址，存在低7位</li>
<li>name：名字</li>
<li>adapter：对应的IIC适配器</li>
<li>dev：设备结构体</li>
<li>irq：中断</li>
</ul>
</li>
<li>IIC设备驱动结构体<code>i2c_driver</code><ul>
<li>probe函数：IIC设备和驱动匹配后调用，初始化用</li>
<li>remove函数：同理，卸载用</li>
<li>id_table：传统方式匹配ID列表</li>
<li>driver：<ul>
<li>owner：所有者，一般为宏THIS_MODULE</li>
<li>name：名字</li>
<li>of_match_table：设备树匹配列表</li>
</ul>
</li>
</ul>
</li>
<li>IIC发送数据结构体<code>i2c_msg</code><ul>
<li>addr：从机地址</li>
<li>flags：标志</li>
<li>len：消息长度</li>
<li>buf：消息数据</li>
</ul>
</li>
</ul>
<h5 id="相关函数-2"><a href="#相关函数-2" class="headerlink" title="相关函数"></a>相关函数</h5><ul>
<li>IIC适配器（控制器）<ul>
<li>i2c_add_adapter：向系统注册i2c_adapter成员，使用动态总线号</li>
<li>i2c_add_numbered_adapter：向系统注册i2c_adapter成员，使用静态总线号</li>
<li>i2c_del_adapter：删除IIC适配器</li>
</ul>
</li>
<li>SPI设备<ul>
<li>i2c_register_driver / i2c_add_driver：注册i2c_driver</li>
<li>i2c_del_driver：卸载i2c_driver</li>
</ul>
</li>
<li>传输数据<ul>
<li>i2c_transfer：传输i2c_msg类型数据</li>
<li>i2c_master_send：IIC发送缓存中的数据，最后会调用i2c_transfer</li>
<li>i2c_master_recv：IIC接收数据到缓存中，最后会调用i2c_transfer</li>
</ul>
</li>
</ul>
<h4 id="5-3调试"><a href="#5-3调试" class="headerlink" title="5.3调试"></a>5.3调试</h4><h5 id="i2c-tools工具"><a href="#i2c-tools工具" class="headerlink" title="i2c-tools工具"></a>i2c-tools工具</h5><p>得益于ubuntucore，直接运行<code>sudo apt install i2c-tools</code>安装i2c-tools工具</p>
<ul>
<li>查询i2c总线<code>sudo i2cdetect -l</code></li>
<li>检测i2c地址<code>sudo i2cdetect -r -y 0</code>（最后的0为i2c-0总线）</li>
</ul>
<h3 id="6-SPI框架驱动"><a href="#6-SPI框架驱动" class="headerlink" title="6.SPI框架驱动"></a>6.SPI框架驱动</h3><h4 id="6-1设备树"><a href="#6-1设备树" class="headerlink" title="6.1设备树"></a>6.1设备树</h4><ul>
<li><code>spi-max-frequency</code>属性：spi总线的最大速度（默认100000，即100k）</li>
<li>status：是否使能该总线<ul>
<li>okay</li>
<li>disabled</li>
</ul>
</li>
<li>spi设备节点需要写到spi总线节点中，作为总线节点的子节点</li>
<li>通过<code>cs-gpios</code>属性指定CS引脚</li>
<li>spi设备节点中<code>reg</code>和节点<code>@</code>后的数字均为该设备所使用的spi通道（一般0即可）</li>
<li>总线节点需要利用<code>pinctrl-names = &quot;default&quot;;</code>和<code>pinctrl-0</code>指定spi引脚（已经设置好）</li>
<li>spi控制器节点<code>compatible</code>属性必须为allwinner,sun8i-h3-spi或allwinner,sun6i-a31-spi，这里在sunxi-h3-h5.dtsi中已经设置好，无需再次设置</li>
</ul>
<p>设备树修改成功后可以通过以下命令来查看是否注册到系统中：</p>
<pre><code class="bash">#查看设备节点，该目录下放着所有的i2c设备
#节点是以i2c地址结尾的文件夹
ls /sys/bus/spi/devices/</code></pre>
<h4 id="6-2驱动"><a href="#6-2驱动" class="headerlink" title="6.2驱动"></a>6.2驱动</h4><h5 id="基本数据结构-1"><a href="#基本数据结构-1" class="headerlink" title="基本数据结构"></a>基本数据结构</h5><ul>
<li>SPI总线结构体<code>spi_bus_type</code><ul>
<li>match函数：驱动和设备匹配是调用该函数来决定是否匹配</li>
</ul>
</li>
<li>SPI主机驱动结构体<code>spi_master</code><ul>
<li>transfer函数：控制器数据传输函数</li>
<li>transfer_one_message函数：控制器数据传输函数，一次发一个spi_message包</li>
</ul>
</li>
<li>SPI设备驱动结构体<code>spi_driver</code><ul>
<li>probe函数：SPI设备和驱动匹配后调用，初始化用</li>
<li>remove函数：同理，卸载用</li>
<li>id_table：传统方式匹配ID列表</li>
<li>driver：<ul>
<li>owner：所有者，一般为宏THIS_MODULE</li>
<li>name：名字</li>
<li>of_match_table：设备树匹配列表</li>
</ul>
</li>
</ul>
</li>
<li>SPI传输信息结构体<code>spi_transfer</code><ul>
<li>tx_buf：发送数据</li>
<li>rx_buf：接收数据</li>
<li>len：数据长度</li>
</ul>
</li>
<li>SPI消息结构体<code>spi_message</code>，由<code>spi_transfer</code>组成<ul>
<li>complete函数：异步传输完成时调用</li>
</ul>
</li>
</ul>
<h5 id="相关函数-3"><a href="#相关函数-3" class="headerlink" title="相关函数"></a>相关函数</h5><ul>
<li>SPI主机<ul>
<li>spi_alloc_master：申请spi_master结构体</li>
<li>spi_master_put：释放spi_master结构体</li>
<li>spi_register_master：注册</li>
<li>spi_unregister_master：注销</li>
</ul>
</li>
<li>SPI设备<ul>
<li>spi_register_driver：注册</li>
<li>spi_unregister_driver：卸载</li>
</ul>
</li>
<li>数据传输<ul>
<li>spi_message_init：初始化spi_message结构体</li>
<li>spi_message_add_tail：将spi_transfer添加到spi_message队列中</li>
<li>spi_sync：同步传输（会阻塞并等待SPI数据传输完成）</li>
<li>spi_async：异步传输（传输完成后会调用spi_message.complete函数）</li>
</ul>
</li>
</ul>
<h4 id="6-3调试"><a href="#6-3调试" class="headerlink" title="6.3调试"></a>6.3调试</h4><h3 id="7-RGBLCD驱动"><a href="#7-RGBLCD驱动" class="headerlink" title="7.RGBLCD驱动"></a>7.RGBLCD驱动</h3><p>Zero默认支持800x480和480x272这两种常见分辨率的的RGB屏幕。这两种分辨率的屏幕，直接在编译时候选择对应的分辨率即可。如果需要修改，可以参考官方手册 <a href="https://www.kancloud.cn/lichee/lpi0/519472" target="_blank" rel="noopener">https://www.kancloud.cn/lichee/lpi0/519472</a> 修改uboot。这里采用的是480*242的RGBLCD。</p>
<p>前提条件：Uboot中需要配置好LCD驱动。设备树种会规定chose节点用于uboot和linux之间传递参数，simple-fb的参数也是在这里传递。 所以只需要uboot中设置屏幕没问题，内核即可正常显示</p>
<h4 id="7-1设备树"><a href="#7-1设备树" class="headerlink" title="7.1设备树"></a>7.1设备树</h4><h5 id="1-添加framebuffer"><a href="#1-添加framebuffer" class="headerlink" title="1.添加framebuffer"></a>1.添加framebuffer</h5><p>参考内核中的设备树绑定文件：<code>\Documentation\devicetree\bindings\display\simple-framebuffer-sunxi.txt</code></p>
<p>需要写到<code>chosen</code>节点中</p>
<p>必要属性：</p>
<ul>
<li>compatible: “allwinner,simple-framebuffer”</li>
<li>allwinner,pipeline为以下几个中的一个<ul>
<li>“de_be0-lcd0”</li>
<li>“de_be1-lcd1”</li>
<li>“de_be0-lcd0-hdmi”</li>
<li>“de_be1-lcd1-hdmi”</li>
</ul>
</li>
</ul>
<p>例子：</p>
<ol>
<li><p>官方例子</p>
<pre><code> chosen {
     #address-cells = &lt;1&gt;;
     #size-cells = &lt;1&gt;;
     ranges;

     framebuffer@0 {
         compatible = &quot;allwinner,simple-framebuffer&quot;, &quot;simple-framebuffer&quot;;
         allwinner,pipeline = &quot;de_be0-lcd0-hdmi&quot;;
         clocks = &lt;&amp;pll5 1&gt;, &lt;&amp;ahb_gates 36&gt;, &lt;&amp;ahb_gates 43&gt;,
              &lt;&amp;ahb_gates 44&gt;;
         status = &quot;disabled&quot;;
     };
 };</code></pre></li>
<li><p>zero例子</p>
<pre><code> chosen {
         #address-cells = &lt;1&gt;;
         #size-cells = &lt;1&gt;;
         ranges;

         simplefb_lcd: framebuffer@0 {
                 compatible = &quot;allwinner,simple-framebuffer&quot;,
                              &quot;simple-framebuffer&quot;;
                 allwinner,pipeline = &quot;de0-lcd0&quot;;
                 clocks = &lt;&amp;ccu CLK_BUS_TCON0&gt;, &lt;&amp;display_clocks 0&gt;,
                          &lt;&amp;display_clocks 6&gt;, &lt;&amp;ccu CLK_TCON0&gt;;
                 status = &quot;disabled&quot;;
         };
 };</code></pre></li>
</ol>
<h5 id="2-添加屏幕节点"><a href="#2-添加屏幕节点" class="headerlink" title="2.添加屏幕节点"></a>2.添加屏幕节点</h5><p>不知道从哪个版本开始，linux内核需要专门的 panel 节点（在根节点下）才行，具体的配置文件的选取可以从 <code>linux ‣ drivers ‣ gpu ‣ drm ‣ panel</code> 文件夹下选取，具体的 compatible 属性从上述文件夹下的<code>panel-simple.c</code>文件中的匹配表<code>platform_of_match</code>中选取</p>
<p>具体的配置可以参考内核帮助文档：<code>\Documentation\devicetree\bindings\display\panel\simple-panel.txt</code>、<code>\Documentation\devicetree\bindings\display\panel\panel-common.txt</code>、<code>\Documentation\devicetree\bindings\graph.txt</code></p>
<p>这里用的是480*272的分辨率的屏幕，具体的 panel 节点配置如下：</p>
<pre><code>panel: panel {
    compatible = &quot;qiaodian,qd43003c0-40&quot;, &quot;simple-panel&quot;;//480*272的屏
    //compatible = “lg,lb070wv8”, “simple-panel”;//800X480的屏
    #address-cells = &lt;1&gt;;
    #size-cells = &lt;0&gt;;
    enable-gpios = &lt;&amp;pio 4 6 GPIO_ACTIVE_HIGH&gt;;//使能引脚 PB4脚为高使能 这里为pwm信号

    port@0 {
        reg = &lt;0&gt;;
        #address-cells = &lt;1&gt;;
        #size-cells = &lt;0&gt;;

        panel_input: endpoint@0 {
            reg = &lt;0&gt;;
            remote-endpoint = &lt;&amp;tcon0_out_lcd&gt;;
        };
    };
};</code></pre><blockquote>
<p>这里解释下ports、port和endpoint（\Documentation\devicetree\bindings\graph.txt）</p>
<p>Ports are described by child ‘port’ nodes contained in the device node.<br>Each port node contains an ‘endpoint’ subnode for each remote device port connected to this port. If a single port is connected to more than one remote device, an ‘endpoint’ child node must be provided for each link.<br>If more than one port is present in a device node or there is more than one endpoint at a port, or a port node needs to be associated with a selected hardware interface, a common scheme using ‘#address-cells’, ‘#size-cells’ and ‘reg’ properties is used to number the nodes.</p>
<p>端口s由设备节点中包含的子“端口”节点描述。<br>每个端口节点都为连接到该端口的每个远程设备端口包含一个“端点”子节点。如果单个端口连接到多个远程设备，则必须为每个链接提供一个“端点”子节点。<br>如果设备节点中存在多个端口，或者某个端口处有多个端点，或者需要将端口节点与选定的硬件接口相关联，则使用“＃address-cells”，“＃size-cells”和’reg’属性的通用方案用于编号节点。 </p>
<p>All ‘port’ nodes can be grouped under an optional ‘ports’ node, which allows to specify #address-cells, #size-cells properties for the ‘port’ nodes independently from any other child device nodes a device might have.</p>
<p>所有“端口”节点都可以分组在一个可选的“端口s”节点下，该节点允许独立于设备可能具有的任何其他子设备节点，为“端口”节点指定＃address-cells，＃size-cells属性。 </p>
</blockquote>
<p>tcon0_out_lcd节点：</p>
<pre><code>//tcon0_out节点是液晶控制器节点tcon0的一个输出端口（port）
&amp;tcon0_out {
    tcon0_out_lcd: endpoint@0 {
        reg = &lt;0&gt;;
        remote-endpoint = &lt;&amp;panel_input&gt;;
    };
};</code></pre><p>同时这里的<code>tcon</code>节点需要绑定上lcd对应的io口</p>
<pre><code>&amp;tcon0 {
    pinctrl-names = &quot;default&quot;;
    pinctrl-0 = &lt;&amp;lcd_rgb666_pins&gt;;//绑定到lcd_rgb666_pins
    status = &quot;okay&quot;;
};</code></pre><p>lcd_rgb666_pins节点：</p>
<pre><code>pio: pinctrl@1c20800 {
    compatible = &quot;allwinner,suniv-pinctrl&quot;;
    ......
    lcd_rgb666_pins: lcd-rgb666-pins {
        pins =    &quot;PE4&quot;, &quot;PE5&quot;, &quot;PE6&quot;, &quot;PE7&quot;, &quot;PE8&quot;, &quot;PE9&quot;,
                &quot;PE10&quot;, &quot;PE11&quot;, &quot;PE12&quot;, &quot;PE13&quot; , &quot;PE14&quot;, &quot;PE15&quot;,
                &quot;PE16&quot;, &quot;PE17&quot;, &quot;PE18&quot;, &quot;PE19&quot;, &quot;PE23&quot;, &quot;PE24&quot;,//data信号
                &quot;PE3&quot;,//VSYNC
                &quot;PE2&quot;,//HSYNC
                &quot;PE1&quot;,//DE
                &quot;PE0&quot;;//CLK
        function = &quot;lcd&quot;;
    };
    ......
};</code></pre><h4 id="7-3调试"><a href="#7-3调试" class="headerlink" title="7.3调试"></a>7.3调试</h4><p>设备树可以通过以下方式检测：</p>
<pre><code class="bash">#会发现framebuffer节点后面被填充了实际地址
ls /proc/device-tree/chosen/
#framebuffer节点一般在：
ls /dev/fb0</code></pre>
<p>屏幕测试方法：</p>
<ol>
<li><p>linux系统启动后，存在/dev/fb0节点：</p>
<pre><code class="bash"> cat /dev/urandom &gt; /dev/fb0</code></pre>
</li>
<li><p>改变uboot的启动参数<code>bootargs</code>，从屏幕输出启动信息</p>
<pre><code class="bash"> setenv bootargs &#39;console=tty1 console=ttyS0,115200 panic=5 rootwait root=/dev/mmcblk0p2 earlyprintk rw vt.global_cursor_default=0&#39;
 boot</code></pre>
</li>
</ol>
<ol start="3">
<li></li>
</ol>

      
       <hr><span style="font-style: italic;color: gray;"> 欢迎指出任何有错误或不够清晰的表达。邮件：1125934312@qq.com </span>
    </div>
</article>



<div class="article_copyright">
    <p><span class="copy-title">文章标题:</span>LiCheePi_Zero底层开发</p>
    <p><span class="copy-title">文章字数:</span><span class="post-count">11.6k</span></p>
    <p><span class="copy-title">本文作者:</span><a href="javascript:void(0)" title="NU-LL">NU-LL</a></p>
    <p><span class="copy-title">发布时间:</span>2019-10-18, 12:25:42</p>
    <p><span class="copy-title">最后更新:</span>2019-11-24, 00:45:11</p>
    <span class="copy-title">原始链接:</span><a class="post-url" href="/2019/10/18/LiCheePi_Zero底层开发/" title="LiCheePi_Zero底层开发">http://NU-LL.github.io/2019/10/18/LiCheePi_Zero底层开发/</a>
    <p>
        <span class="copy-title">版权声明:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/" title="CC BY-NC-SA 4.0 International" target = "_blank">"署名-非商用-相同方式共享 4.0"</a> 转载请保留原文链接及作者。
    </p>
</div>





    




    </div>
    <div class="copyright">
        <p class="footer-entry">©2016-2019 NU-LL</p>
<p class="footer-entry">Built with <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/yelog/hexo-theme-3-hexo" target="_blank">3-hexo</a> theme</p>

    </div>
    <div class="full-toc">
        <button class="full"><span class="min "></span></button>
<button class="post-toc-menu"><span class="post-toc-menu-icons"></span></button>
<div class="post-toc"><span class="post-toc-title">目录</span>
    <div class="post-toc-content">

    </div>
</div>
<a class="" id="rocket" href="javascript:void(0)"></a>
    </div>
</div>
<div class="acParent"></div>

</body>
<script src="//cdn.bootcss.com/jquery.pjax/2.0.1/jquery.pjax.min.js"></script>

<script src="/js/script.js?v=1" ></script>
<script>
    var img_resize = 'default';
    /*作者、标签的自动补全*/
    $(function () {
        $('.search').AutoComplete({
            'data': ['#DM9000C','#网卡移植','#Go语言入门经典','#Kconfig语法','#IIC驱动','#Latex','#Ctex','#Linux内核','#LiCheePi Zero','#文件描述符','#Xmanager','#远程链接','#字符驱动','#等待队列','#wait_queue_head_t','#wait_queue_t','#Markdown','#git','#NanoPi Neo Core','#u-boot','#存储器','#markdownlint','#二维数组','#指针','#按键驱动','#poll机制','#快速排序','#根文件系统','#异步通知机制','#IAP','#BootLoader','#dual bank','#深度学习','#TensorFlow2','#设备树','#网卡驱动框架','#虚拟网卡','#输入子系统',],
            'itemHeight': 20,
            'width': 418
        }).AutoComplete('show');
    })
    function initArticle() {
        /*渲染对应的表格样式*/
        

        /*渲染打赏样式*/
        

        /*高亮代码块行号*/
        
        $('pre code').each(function(){
            var lines = $(this).text().split('\n').length - 1, widther='';
            if (lines>99) {
                widther = 'widther'
            }
            var $numbering = $('<ul/>').addClass('pre-numbering ' + widther).attr("unselectable","on");
            $(this).addClass('has-numbering ' + widther)
                    .parent()
                    .append($numbering);
            for(var i=1;i<=lines;i++){
                $numbering.append($('<li/>').text(i));
            }
        });
        

        /*访问数量*/
        
        $.getScript("//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js");
        

        /*代码高亮，行号对齐*/
        $('.pre-numbering').css('line-height',$('.has-numbering').css('line-height'));

        
    }

    /*打赏页面隐藏与展示*/
    

</script>

<!--加入行号的高亮代码块样式-->

<style>
    pre{
        position: relative;
        margin-bottom: 24px;
        border-radius: 10px;
        border: 1px solid #e2dede;
        background: #FFF;
        overflow: hidden;
    }
    code.has-numbering{
        margin-left: 30px;
    }
    code.has-numbering.widther{
        margin-left: 35px;
    }
    .pre-numbering{
        margin: 0px;
        position: absolute;
        top: 0;
        left: 0;
        width: 20px;
        padding: 0.5em 3px 0.7em 5px;
        border-right: 1px solid #C3CCD0;
        text-align: right;
        color: #AAA;
        background-color: ;
    }
    .pre-numbering.widther {
        width: 35px;
    }
</style>

<!--自定义样式设置-->
<style>
    
    .nav-right nav a.hover, #local-search-result a.hover{
        background-color: #e2e0e0;
    }
    
    

    /*列表样式*/
    
    .post .pjax article .article-entry>ol, .post .pjax article .article-entry>ul, .post .pjax article>ol, .post .pjax article>ul{
        border: #e2dede solid 1px;
        border-radius: 10px;
        padding: 10px 32px 10px 56px;
    }
    .post .pjax article .article-entry li>ol, .post .pjax article .article-entry li>ul,.post .pjax article li>ol, .post .pjax article li>ul{
        padding-top: 5px;
        padding-bottom: 5px;
    }
    .post .pjax article .article-entry>ol>li, .post .pjax article .article-entry>ul>li,.post .pjax article>ol>li, .post .pjax article>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    .post .pjax article .article-entry li>ol>li, .post .pjax article .article-entry li>ul>li,.post .pjax article li>ol>li, .post .pjax article li>ul>li{
        margin-bottom: auto;
        margin-left: auto;
    }
    

    /* 背景图样式 */
    
    


    /*引用块样式*/
    
    .post .pjax article blockquote {
        padding: 10px 20px;
        background-color: white;
        border: none;
        border-left: 4px solid #42b983;
        border-right: 4px solid #42b983;
        border-radius: 10px;
    }
    

    /*文章列表背景图*/
    

    
</style>







</html>
